/*
 * Basic jQuery Slider plug-in v.1.3
 *
 * http://www.basic-slider.com
 *
 * Authored by John Cobb
 * http://www.johncobb.name
 * @john0514
 *
 * Copyright 2011, John Cobb
 * License: GNU General Public License, version 3 (GPL-3.0)
 * http://www.opensource.org/licenses/gpl-3.0.html
 *
 */

;(function($) {

    "use strict";

    $.fn.bjqs = function(o) {
        
        // slider default settings
        var defaults        = {

            // w + h to enforce consistency
            width           : 700,
            height          : 300,

            // transition valuess
            animtype        : 'fade',
            animduration    : 450,      // length of transition
            animspeed       : 4000,     // delay between transitions
            automatic       : true,     // enable/disable automatic slide rotation

            // control and marker configuration
            showcontrols    : true,     // enable/disable next + previous UI elements
            centercontrols  : true,     // vertically center controls
            nexttext        : 'Next',   // text/html inside next UI element
            prevtext        : 'Prev',   // text/html inside previous UI element
            showmarkers     : true,     // enable/disable individual slide UI markers
            centermarkers   : true,     // horizontally center markers

            // interaction values
            keyboardnav     : true,     // enable/disable keyboard navigation
            hoverpause      : true,     // enable/disable pause slides on hover

            // presentational options
            usecaptions     : true,     // enable/disable captions using img title attribute
            randomstart     : false,     // start from a random slide
            responsive      : false     // enable responsive behaviour

        };

        // create settings from defauls and user options
        var settings        = $.extend({}, defaults, o);

        // slider elements
        var $wrapper        = this,
            $slider         = $wrapper.find('ul.bjqs'),
            $slides         = $slider.children('li'),

            // control elements
            $c_wrapper      = null,
            $c_fwd          = null,
            $c_prev         = null,

            // marker elements
            $m_wrapper      = null,
            $m_markers      = null,

            // elements for slide animation
            $canvas         = null,
            $clone_first    = null,
            $clone_last     = null;

        // state management object
        var state           = {
            slidecount      : $slides.length,   // total number of slides
            animating       : false,            // bool: is transition is progress
            paused          : false,            // bool: is the slider paused
            currentslide    : 1,                // current slide being viewed (not 0 based)
            nextslide       : 0,                // slide to view next (not 0 based)
            currentindex    : 0,                // current slide being viewed (0 based)
            nextindex       : 0,                // slide to view next (0 based)
            interval        : null              // interval for automatic rotation
        };

        var responsive      = {
            width           : null,
            height          : null,
            ratio           : null
        };

        // helpful variables
        var vars            = {
            fwd             : 'forward',
            prev            : 'previous'
        };
            
        // run through options and initialise settings
        var init = function() {

            // differentiate slider li from content li
            $slides.addClass('bjqs-slide');

            // conf dimensions, responsive or static
            if( settings.responsive ){
                conf_responsive();
            }
            else{
                conf_static();
            }

            // configurations only avaliable if more than 1 slide
            if( state.slidecount > 1 ){

                // enable random start
                if (settings.randomstart){
                    conf_random();
                }

                // create and show controls
                if( settings.showcontrols ){
                    conf_controls();
                }

                // create and show markers
                if( settings.showmarkers ){
                    conf_markers();
                }

                // enable slidenumboard navigation
                if( settings.keyboardnav ){
                    conf_keynav();
                }

                // enable pause on hover
                if (settings.hoverpause && settings.automatic){
                    conf_hoverpause();
                }

                // conf slide animation
                if (settings.animtype === 'slide'){
                    conf_slide();
                }

            } else {
                // Stop automatic animation, because we only have one slide! 
                settings.automatic = false;
            }

            if(settings.usecaptions){
                conf_captions();
            }

            // TODO: need to accomodate random start for slide transition setting
            if(settings.animtype === 'slide' && !settings.randomstart){
                state.currentindex = 1;
                state.currentslide = 2;
            }

            // slide components are hidden by default, show them now
            $slider.show();
            $slides.eq(state.currentindex).show();

            // Finally, if automatic is set to true, kick off the interval
            if(settings.automatic){
                state.interval = setInterval(function () {
                    go(vars.fwd, false);
                }, settings.animspeed);
            }

        };

        var conf_responsive = function() {

            responsive.width    = $wrapper.outerWidth();
            responsive.ratio    = responsive.width/settings.width,
            responsive.height   = settings.height * responsive.ratio;

            if(settings.animtype === 'fade'){

                // initial setup
                $slides.css({
                    'height'        : settings.height,
                    'width'         : '100%'
                });
                $slides.children('img').css({
                    'height'        : settings.height,
                    'width'         : '100%'
                });
                $slider.css({
                    'height'        : settings.height,
                    'width'         : '100%'
                });
                $wrapper.css({
                    'height'        : settings.height,
                    'max-width'     : settings.width,
                    'position'      : 'relative'
                });

                if(responsive.width < settings.width){

                    $slides.css({
                        'height'        : responsive.height
                    });
                    $slides.children('img').css({
                        'height'        : responsive.height
                    });
                    $slider.css({
                        'height'        : responsive.height
                    });
                    $wrapper.css({
                        'height'        : responsive.height
                    });

                }

                $(window).resize(function() {

                    // calculate and update dimensions
                    responsive.width    = $wrapper.outerWidth();
                    responsive.ratio    = responsive.width/settings.width,
                    responsive.height   = settings.height * responsive.ratio;

                    $slides.css({
                        'height'        : responsive.height
                    });
                    $slides.children('img').css({
                        'height'        : responsive.height
                    });
                    $slider.css({
                        'height'        : responsive.height
                    });
                    $wrapper.css({
                        'height'        : responsive.height
                    });

                });

            }

            if(settings.animtype === 'slide'){

                // initial setup
                $slides.css({
                    'height'        : settings.height,
                    'width'         : settings.width
                });
                $slides.children('img').css({
                    'height'        : settings.height,
                    'width'         : settings.width
                });
                $slider.css({
                    'height'        : settings.height,
                    'width'         : settings.width * settings.slidecount
                });
                $wrapper.css({
                    'height'        : settings.height,
                    'max-width'     : settings.width,
                    'position'      : 'relative'
                });

                if(responsive.width < settings.width){

                    $slides.css({
                        'height'        : responsive.height
                    });
                    $slides.children('img').css({
                        'height'        : responsive.height
                    });
                    $slider.css({
                        'height'        : responsive.height
                    });
                    $wrapper.css({
                        'height'        : responsive.height
                    });

                }

                $(window).resize(function() {

                    // calculate and update dimensions
                    responsive.width    = $wrapper.outerWidth(),
                    responsive.ratio    = responsive.width/settings.width,
                    responsive.height   = settings.height * responsive.ratio;

                    $slides.css({
                        'height'        : responsive.height,
                        'width'         : responsive.width
                    });
                    $slides.children('img').css({
                        'height'        : responsive.height,
                        'width'         : responsive.width
                    });
                    $slider.css({
                        'height'        : responsive.height,
                        'width'         : responsive.width * settings.slidecount
                    });
                    $wrapper.css({
                        'height'        : responsive.height
                    });
                    $canvas.css({
                        'height'        : responsive.height,
                        'width'         : responsive.width
                    });

                    resize_complete(function(){
                        go(false,state.currentslide);
                    }, 200, "some unique string");

                });

            }

        };

        var resize_complete = (function () {
            
            var timers = {};
            
            return function (callback, ms, uniqueId) {
                if (!uniqueId) {
                    uniqueId = "Don't call this twice without a uniqueId";
                }
                if (timers[uniqueId]) {
                    clearTimeout (timers[uniqueId]);
                }
                timers[uniqueId] = setTimeout(callback, ms);
            };

        })();

        // enforce fixed sizing on slides, slider and wrapper
        var conf_static = function() {

            $slides.css({
                'height'    : settings.height,
                'width'     : settings.width
            });
            $slider.css({
                'height'    : settings.height,
                'width'     : settings.width
            });
            $wrapper.css({
                'height'    : settings.height,
                'width'     : settings.width,
                'position'  : 'relative'
            });

        };

        var conf_slide = function() {

            // create two extra elements which are clones of the first and last slides
            $clone_first    = $slides.eq(0).clone();
            $clone_last     = $slides.eq(state.slidecount-1).clone();

            // add them to the DOM where we need them
            $clone_first.attr({'data-clone' : 'last', 'data-slide' : 0}).appendTo($slider).show();
            $clone_last.attr({'data-clone' : 'first', 'data-slide' : 0}).prependTo($slider).show();

            // update the elements object
            $slides             = $slider.children('li');
            state.slidecount    = $slides.length;

            // create a 'canvas' element which is neccessary for the slide animation to work
            $canvas = $('<div class="bjqs-wrapper"></div>');

            // if the slider is responsive && the calculated width is less than the max width
            if(settings.responsive && (responsive.width < settings.width)){

                $canvas.css({
                    'width'     : responsive.width,
                    'height'    : responsive.height,
                    'overflow'  : 'hidden',
                    'position'  : 'relative'
                });

                // update the dimensions to the slider to accomodate all the slides side by side
                $slider.css({
                    'width'     : responsive.width * (state.slidecount + 2),
                    'left'      : -responsive.width * state.currentslide
                });

            }
            else {

                $canvas.css({
                    'width'     : settings.width,
                    'height'    : settings.height,
                    'overflow'  : 'hidden',
                    'position'  : 'relative'
                });

                // update the dimensions to the slider to accomodate all the slides side by side
                $slider.css({
                    'width'     : settings.width * (state.slidecount + 2),
                    'left'      : -settings.width * state.currentslide
                });

            }

            // add some inline styles which will align our slides for left-right sliding
            $slides.css({
                'float'         : 'left',
                'position'      : 'relative',
                'display'       : 'list-item'
            });

            // 'everything.. in it's right place'
            $canvas.prependTo($wrapper);
            $slider.appendTo($canvas);

        };

        var conf_controls = function() {

            // create the elements for the controls
            $c_wrapper  = $('<ul class="bjqs-controls"></ul>');
            $c_fwd      = $('<li class="bjqs-next"><a href="#" data-direction="'+ vars.fwd +'">' + settings.nexttext + '</a></li>');
            $c_prev     = $('<li class="bjqs-prev"><a href="#" data-direction="'+ vars.prev +'">' + settings.prevtext + '</a></li>');

            // bind click events
            $c_wrapper.on('click','a',function(e){

                e.preventDefault();
                var direction = $(this).attr('data-direction');

                if(!state.animating){

                    if(direction === vars.fwd){
                        go(vars.fwd,false);
                    }

                    if(direction === vars.prev){
                        go(vars.prev,false);
                    }

                }

            });

            // put 'em all together
            $c_prev.appendTo($c_wrapper);
            $c_fwd.appendTo($c_wrapper);
            $c_wrapper.appendTo($wrapper);

            // vertically center the controls
            if (settings.centercontrols) {

                $c_wrapper.addClass('v-centered');

                // calculate offset % for vertical positioning
                var offset_px   = ($wrapper.height() - $c_fwd.children('a').outerHeight()) / 2,
                    ratio       = (offset_px / settings.height) * 100,
                    offset      = ratio + '%';

                $c_fwd.find('a').css('top', offset);
                $c_prev.find('a').css('top', offset);

            }

        };

        var conf_markers = function() {

            // create a wrapper for our markers
            $m_wrapper = $('<ol class="bjqs-markers"></ol>');

            // for every slide, create a marker
            $.each($slides, function(key, slide){

                var slidenum    = key + 1,
                    gotoslide   = key + 1;
                
                if(settings.animtype === 'slide'){
                    // + 2 to account for clones
                    gotoslide = key + 2;
                }

                var marker = $('<li><a href="#">'+ slidenum +'</a></li>');

                // set the first marker to be active
                if(slidenum === state.currentslide){ marker.addClass('active-marker'); }

                // bind the click event
                marker.on('click','a',function(e){
                    e.preventDefault();
                    if(!state.animating && state.currentslide !== gotoslide){
                        go(false,gotoslide);
                    }
                });

                // add the marker to the wrapper
                marker.appendTo($m_wrapper);

            });

            $m_wrapper.appendTo($wrapper);
            $m_markers = $m_wrapper.find('li');

            // center the markers
            if (settings.centermarkers) {
                $m_wrapper.addClass('h-centered');
                var offset = (settings.width - $m_wrapper.width()) / 2;
                $m_wrapper.css('left', offset);
            }

        };

        var conf_keynav = function() {

            $(document).keyup(function (event) {

                if (!state.paused) {
                    clearInterval(state.interval);
                    state.paused = true;
                }

                if (!state.animating) {
                    if (event.keyCode === 39) {
                        event.preventDefault();
                        go(vars.fwd, false);
                    } else if (event.keyCode === 37) {
                        event.preventDefault();
                        go(vars.prev, false);
                    }
                }

                if (state.paused && settings.automatic) {
                    state.interval = setInterval(function () {
                        go(vars.fwd);
                    }, settings.animspeed);
                    state.paused = false;
                }

            });

        };

        var conf_hoverpause = function() {

            $wrapper.hover(function () {
                if (!state.paused) {
                    clearInterval(state.interval);
                    state.paused = true;
                }
            }, function () {
                if (state.paused) {
                    state.interval = setInterval(function () {
                        go(vars.fwd, false);
                    }, settings.animspeed);
                    state.paused = false;
                }
            });

        };

        var conf_captions = function() {

            $.each($slides, function (key, slide) {

                var caption = $(slide).children('img:first-child').attr('title');

                // Account for images wrapped in links
                if(!caption){
                    caption = $(slide).children('a').find('img:first-child').attr('title');
                }

                if (caption) {
                    caption = $('<p class="bjqs-caption">' + caption + '</p>');
                    caption.appendTo($(slide));
                }

            });

        };

        var conf_random = function() {

            var rand            = Math.floor(Math.random() * state.slidecount) + 1;
            state.currentslide  = rand;
            state.currentindex  = rand-1;

        };

        var set_next = function(direction) {

            if(direction === vars.fwd){
                
                if($slides.eq(state.currentindex).next().length){
                    state.nextindex = state.currentindex + 1;
                    state.nextslide = state.currentslide + 1;
                }
                else{
                    state.nextindex = 0;
                    state.nextslide = 1;
                }

            }
            else{

                if($slides.eq(state.currentindex).prev().length){
                    state.nextindex = state.currentindex - 1;
                    state.nextslide = state.currentslide - 1;
                }
                else{
                    state.nextindex = state.slidecount - 1;
                    state.nextslide = state.slidecount;
                }

            }

        };

        var go = function(direction, position) {

            // only if we're not already doing things
            if(!state.animating){

                // doing things
                state.animating = true;

                if(position){
                    state.nextslide = position;
                    state.nextindex = position-1;
                }
                else{
                    set_next(direction);
                }

                // fade animation
                if(settings.animtype === 'fade'){

                    if(settings.showmarkers){
                        $m_markers.removeClass('active-marker');
                        $m_markers.eq(state.nextindex).addClass('active-marker');
                    }

                    // fade out current
                    $slides.eq(state.currentindex).fadeOut(settings.animduration);
                    // fade in next
                    $slides.eq(state.nextindex).fadeIn(settings.animduration, function(){

                        // update state variables
                        state.animating = false;
                        state.currentslide = state.nextslide;
                        state.currentindex = state.nextindex;

                    });

                }

                // slide animation
                if(settings.animtype === 'slide'){

                    if(settings.showmarkers){
                        
                        var markerindex = state.nextindex-1;

                        if(markerindex === state.slidecount-2){
                            markerindex = 0;
                        }
                        else if(markerindex === -1){
                            markerindex = state.slidecount-3;
                        }

                        $m_markers.removeClass('active-marker');
                        $m_markers.eq(markerindex).addClass('active-marker');
                    }

                    // if the slider is responsive && the calculated width is less than the max width
                    if(settings.responsive && ( responsive.width < settings.width ) ){
                        state.slidewidth = responsive.width;
                    }
                    else{
                        state.slidewidth = settings.width;
                    }

                    $slider.animate({'left': -state.nextindex * state.slidewidth }, settings.animduration, function(){

                        state.currentslide = state.nextslide;
                        state.currentindex = state.nextindex;

                        // is the current slide a clone?
                        if($slides.eq(state.currentindex).attr('data-clone') === 'last'){

                            // affirmative, at the last slide (clone of first)
                            $slider.css({'left': -state.slidewidth });
                            state.currentslide = 2;
                            state.currentindex = 1;

                        }
                        else if($slides.eq(state.currentindex).attr('data-clone') === 'first'){

                            // affirmative, at the fist slide (clone of last)
                            $slider.css({'left': -state.slidewidth *(state.slidecount - 2)});
                            state.currentslide = state.slidecount - 1;
                            state.currentindex = state.slidecount - 2;

                        }

                        state.animating = false;

                    });

                }

            }

        };

        // lets get the party started :)
        init();

    };

})(jQuery);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJianFzLTEuMy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQmFzaWMgalF1ZXJ5IFNsaWRlciBwbHVnLWluIHYuMS4zXG4gKlxuICogaHR0cDovL3d3dy5iYXNpYy1zbGlkZXIuY29tXG4gKlxuICogQXV0aG9yZWQgYnkgSm9obiBDb2JiXG4gKiBodHRwOi8vd3d3LmpvaG5jb2JiLm5hbWVcbiAqIEBqb2huMDUxNFxuICpcbiAqIENvcHlyaWdodCAyMDExLCBKb2huIENvYmJcbiAqIExpY2Vuc2U6IEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlLCB2ZXJzaW9uIDMgKEdQTC0zLjApXG4gKiBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2dwbC0zLjAuaHRtbFxuICpcbiAqL1xuXG47KGZ1bmN0aW9uKCQpIHtcblxuICAgIFwidXNlIHN0cmljdFwiO1xuXG4gICAgJC5mbi5ianFzID0gZnVuY3Rpb24obykge1xuICAgICAgICBcbiAgICAgICAgLy8gc2xpZGVyIGRlZmF1bHQgc2V0dGluZ3NcbiAgICAgICAgdmFyIGRlZmF1bHRzICAgICAgICA9IHtcblxuICAgICAgICAgICAgLy8gdyArIGggdG8gZW5mb3JjZSBjb25zaXN0ZW5jeVxuICAgICAgICAgICAgd2lkdGggICAgICAgICAgIDogNzAwLFxuICAgICAgICAgICAgaGVpZ2h0ICAgICAgICAgIDogMzAwLFxuXG4gICAgICAgICAgICAvLyB0cmFuc2l0aW9uIHZhbHVlc3NcbiAgICAgICAgICAgIGFuaW10eXBlICAgICAgICA6ICdmYWRlJyxcbiAgICAgICAgICAgIGFuaW1kdXJhdGlvbiAgICA6IDQ1MCwgICAgICAvLyBsZW5ndGggb2YgdHJhbnNpdGlvblxuICAgICAgICAgICAgYW5pbXNwZWVkICAgICAgIDogNDAwMCwgICAgIC8vIGRlbGF5IGJldHdlZW4gdHJhbnNpdGlvbnNcbiAgICAgICAgICAgIGF1dG9tYXRpYyAgICAgICA6IHRydWUsICAgICAvLyBlbmFibGUvZGlzYWJsZSBhdXRvbWF0aWMgc2xpZGUgcm90YXRpb25cblxuICAgICAgICAgICAgLy8gY29udHJvbCBhbmQgbWFya2VyIGNvbmZpZ3VyYXRpb25cbiAgICAgICAgICAgIHNob3djb250cm9scyAgICA6IHRydWUsICAgICAvLyBlbmFibGUvZGlzYWJsZSBuZXh0ICsgcHJldmlvdXMgVUkgZWxlbWVudHNcbiAgICAgICAgICAgIGNlbnRlcmNvbnRyb2xzICA6IHRydWUsICAgICAvLyB2ZXJ0aWNhbGx5IGNlbnRlciBjb250cm9sc1xuICAgICAgICAgICAgbmV4dHRleHQgICAgICAgIDogJ05leHQnLCAgIC8vIHRleHQvaHRtbCBpbnNpZGUgbmV4dCBVSSBlbGVtZW50XG4gICAgICAgICAgICBwcmV2dGV4dCAgICAgICAgOiAnUHJldicsICAgLy8gdGV4dC9odG1sIGluc2lkZSBwcmV2aW91cyBVSSBlbGVtZW50XG4gICAgICAgICAgICBzaG93bWFya2VycyAgICAgOiB0cnVlLCAgICAgLy8gZW5hYmxlL2Rpc2FibGUgaW5kaXZpZHVhbCBzbGlkZSBVSSBtYXJrZXJzXG4gICAgICAgICAgICBjZW50ZXJtYXJrZXJzICAgOiB0cnVlLCAgICAgLy8gaG9yaXpvbnRhbGx5IGNlbnRlciBtYXJrZXJzXG5cbiAgICAgICAgICAgIC8vIGludGVyYWN0aW9uIHZhbHVlc1xuICAgICAgICAgICAga2V5Ym9hcmRuYXYgICAgIDogdHJ1ZSwgICAgIC8vIGVuYWJsZS9kaXNhYmxlIGtleWJvYXJkIG5hdmlnYXRpb25cbiAgICAgICAgICAgIGhvdmVycGF1c2UgICAgICA6IHRydWUsICAgICAvLyBlbmFibGUvZGlzYWJsZSBwYXVzZSBzbGlkZXMgb24gaG92ZXJcblxuICAgICAgICAgICAgLy8gcHJlc2VudGF0aW9uYWwgb3B0aW9uc1xuICAgICAgICAgICAgdXNlY2FwdGlvbnMgICAgIDogdHJ1ZSwgICAgIC8vIGVuYWJsZS9kaXNhYmxlIGNhcHRpb25zIHVzaW5nIGltZyB0aXRsZSBhdHRyaWJ1dGVcbiAgICAgICAgICAgIHJhbmRvbXN0YXJ0ICAgICA6IGZhbHNlLCAgICAgLy8gc3RhcnQgZnJvbSBhIHJhbmRvbSBzbGlkZVxuICAgICAgICAgICAgcmVzcG9uc2l2ZSAgICAgIDogZmFsc2UgICAgIC8vIGVuYWJsZSByZXNwb25zaXZlIGJlaGF2aW91clxuXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gY3JlYXRlIHNldHRpbmdzIGZyb20gZGVmYXVscyBhbmQgdXNlciBvcHRpb25zXG4gICAgICAgIHZhciBzZXR0aW5ncyAgICAgICAgPSAkLmV4dGVuZCh7fSwgZGVmYXVsdHMsIG8pO1xuXG4gICAgICAgIC8vIHNsaWRlciBlbGVtZW50c1xuICAgICAgICB2YXIgJHdyYXBwZXIgICAgICAgID0gdGhpcyxcbiAgICAgICAgICAgICRzbGlkZXIgICAgICAgICA9ICR3cmFwcGVyLmZpbmQoJ3VsLmJqcXMnKSxcbiAgICAgICAgICAgICRzbGlkZXMgICAgICAgICA9ICRzbGlkZXIuY2hpbGRyZW4oJ2xpJyksXG5cbiAgICAgICAgICAgIC8vIGNvbnRyb2wgZWxlbWVudHNcbiAgICAgICAgICAgICRjX3dyYXBwZXIgICAgICA9IG51bGwsXG4gICAgICAgICAgICAkY19md2QgICAgICAgICAgPSBudWxsLFxuICAgICAgICAgICAgJGNfcHJldiAgICAgICAgID0gbnVsbCxcblxuICAgICAgICAgICAgLy8gbWFya2VyIGVsZW1lbnRzXG4gICAgICAgICAgICAkbV93cmFwcGVyICAgICAgPSBudWxsLFxuICAgICAgICAgICAgJG1fbWFya2VycyAgICAgID0gbnVsbCxcblxuICAgICAgICAgICAgLy8gZWxlbWVudHMgZm9yIHNsaWRlIGFuaW1hdGlvblxuICAgICAgICAgICAgJGNhbnZhcyAgICAgICAgID0gbnVsbCxcbiAgICAgICAgICAgICRjbG9uZV9maXJzdCAgICA9IG51bGwsXG4gICAgICAgICAgICAkY2xvbmVfbGFzdCAgICAgPSBudWxsO1xuXG4gICAgICAgIC8vIHN0YXRlIG1hbmFnZW1lbnQgb2JqZWN0XG4gICAgICAgIHZhciBzdGF0ZSAgICAgICAgICAgPSB7XG4gICAgICAgICAgICBzbGlkZWNvdW50ICAgICAgOiAkc2xpZGVzLmxlbmd0aCwgICAvLyB0b3RhbCBudW1iZXIgb2Ygc2xpZGVzXG4gICAgICAgICAgICBhbmltYXRpbmcgICAgICAgOiBmYWxzZSwgICAgICAgICAgICAvLyBib29sOiBpcyB0cmFuc2l0aW9uIGlzIHByb2dyZXNzXG4gICAgICAgICAgICBwYXVzZWQgICAgICAgICAgOiBmYWxzZSwgICAgICAgICAgICAvLyBib29sOiBpcyB0aGUgc2xpZGVyIHBhdXNlZFxuICAgICAgICAgICAgY3VycmVudHNsaWRlICAgIDogMSwgICAgICAgICAgICAgICAgLy8gY3VycmVudCBzbGlkZSBiZWluZyB2aWV3ZWQgKG5vdCAwIGJhc2VkKVxuICAgICAgICAgICAgbmV4dHNsaWRlICAgICAgIDogMCwgICAgICAgICAgICAgICAgLy8gc2xpZGUgdG8gdmlldyBuZXh0IChub3QgMCBiYXNlZClcbiAgICAgICAgICAgIGN1cnJlbnRpbmRleCAgICA6IDAsICAgICAgICAgICAgICAgIC8vIGN1cnJlbnQgc2xpZGUgYmVpbmcgdmlld2VkICgwIGJhc2VkKVxuICAgICAgICAgICAgbmV4dGluZGV4ICAgICAgIDogMCwgICAgICAgICAgICAgICAgLy8gc2xpZGUgdG8gdmlldyBuZXh0ICgwIGJhc2VkKVxuICAgICAgICAgICAgaW50ZXJ2YWwgICAgICAgIDogbnVsbCAgICAgICAgICAgICAgLy8gaW50ZXJ2YWwgZm9yIGF1dG9tYXRpYyByb3RhdGlvblxuICAgICAgICB9O1xuXG4gICAgICAgIHZhciByZXNwb25zaXZlICAgICAgPSB7XG4gICAgICAgICAgICB3aWR0aCAgICAgICAgICAgOiBudWxsLFxuICAgICAgICAgICAgaGVpZ2h0ICAgICAgICAgIDogbnVsbCxcbiAgICAgICAgICAgIHJhdGlvICAgICAgICAgICA6IG51bGxcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBoZWxwZnVsIHZhcmlhYmxlc1xuICAgICAgICB2YXIgdmFycyAgICAgICAgICAgID0ge1xuICAgICAgICAgICAgZndkICAgICAgICAgICAgIDogJ2ZvcndhcmQnLFxuICAgICAgICAgICAgcHJldiAgICAgICAgICAgIDogJ3ByZXZpb3VzJ1xuICAgICAgICB9O1xuICAgICAgICAgICAgXG4gICAgICAgIC8vIHJ1biB0aHJvdWdoIG9wdGlvbnMgYW5kIGluaXRpYWxpc2Ugc2V0dGluZ3NcbiAgICAgICAgdmFyIGluaXQgPSBmdW5jdGlvbigpIHtcblxuICAgICAgICAgICAgLy8gZGlmZmVyZW50aWF0ZSBzbGlkZXIgbGkgZnJvbSBjb250ZW50IGxpXG4gICAgICAgICAgICAkc2xpZGVzLmFkZENsYXNzKCdianFzLXNsaWRlJyk7XG5cbiAgICAgICAgICAgIC8vIGNvbmYgZGltZW5zaW9ucywgcmVzcG9uc2l2ZSBvciBzdGF0aWNcbiAgICAgICAgICAgIGlmKCBzZXR0aW5ncy5yZXNwb25zaXZlICl7XG4gICAgICAgICAgICAgICAgY29uZl9yZXNwb25zaXZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNle1xuICAgICAgICAgICAgICAgIGNvbmZfc3RhdGljKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIGNvbmZpZ3VyYXRpb25zIG9ubHkgYXZhbGlhYmxlIGlmIG1vcmUgdGhhbiAxIHNsaWRlXG4gICAgICAgICAgICBpZiggc3RhdGUuc2xpZGVjb3VudCA+IDEgKXtcblxuICAgICAgICAgICAgICAgIC8vIGVuYWJsZSByYW5kb20gc3RhcnRcbiAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3MucmFuZG9tc3RhcnQpe1xuICAgICAgICAgICAgICAgICAgICBjb25mX3JhbmRvbSgpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBhbmQgc2hvdyBjb250cm9sc1xuICAgICAgICAgICAgICAgIGlmKCBzZXR0aW5ncy5zaG93Y29udHJvbHMgKXtcbiAgICAgICAgICAgICAgICAgICAgY29uZl9jb250cm9scygpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBhbmQgc2hvdyBtYXJrZXJzXG4gICAgICAgICAgICAgICAgaWYoIHNldHRpbmdzLnNob3dtYXJrZXJzICl7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZfbWFya2VycygpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIGVuYWJsZSBzbGlkZW51bWJvYXJkIG5hdmlnYXRpb25cbiAgICAgICAgICAgICAgICBpZiggc2V0dGluZ3Mua2V5Ym9hcmRuYXYgKXtcbiAgICAgICAgICAgICAgICAgICAgY29uZl9rZXluYXYoKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvLyBlbmFibGUgcGF1c2Ugb24gaG92ZXJcbiAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3MuaG92ZXJwYXVzZSAmJiBzZXR0aW5ncy5hdXRvbWF0aWMpe1xuICAgICAgICAgICAgICAgICAgICBjb25mX2hvdmVycGF1c2UoKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvLyBjb25mIHNsaWRlIGFuaW1hdGlvblxuICAgICAgICAgICAgICAgIGlmIChzZXR0aW5ncy5hbmltdHlwZSA9PT0gJ3NsaWRlJyl7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZfc2xpZGUoKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gU3RvcCBhdXRvbWF0aWMgYW5pbWF0aW9uLCBiZWNhdXNlIHdlIG9ubHkgaGF2ZSBvbmUgc2xpZGUhIFxuICAgICAgICAgICAgICAgIHNldHRpbmdzLmF1dG9tYXRpYyA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZihzZXR0aW5ncy51c2VjYXB0aW9ucyl7XG4gICAgICAgICAgICAgICAgY29uZl9jYXB0aW9ucygpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBUT0RPOiBuZWVkIHRvIGFjY29tb2RhdGUgcmFuZG9tIHN0YXJ0IGZvciBzbGlkZSB0cmFuc2l0aW9uIHNldHRpbmdcbiAgICAgICAgICAgIGlmKHNldHRpbmdzLmFuaW10eXBlID09PSAnc2xpZGUnICYmICFzZXR0aW5ncy5yYW5kb21zdGFydCl7XG4gICAgICAgICAgICAgICAgc3RhdGUuY3VycmVudGluZGV4ID0gMTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5jdXJyZW50c2xpZGUgPSAyO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBzbGlkZSBjb21wb25lbnRzIGFyZSBoaWRkZW4gYnkgZGVmYXVsdCwgc2hvdyB0aGVtIG5vd1xuICAgICAgICAgICAgJHNsaWRlci5zaG93KCk7XG4gICAgICAgICAgICAkc2xpZGVzLmVxKHN0YXRlLmN1cnJlbnRpbmRleCkuc2hvdygpO1xuXG4gICAgICAgICAgICAvLyBGaW5hbGx5LCBpZiBhdXRvbWF0aWMgaXMgc2V0IHRvIHRydWUsIGtpY2sgb2ZmIHRoZSBpbnRlcnZhbFxuICAgICAgICAgICAgaWYoc2V0dGluZ3MuYXV0b21hdGljKXtcbiAgICAgICAgICAgICAgICBzdGF0ZS5pbnRlcnZhbCA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgZ28odmFycy5md2QsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICB9LCBzZXR0aW5ncy5hbmltc3BlZWQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGNvbmZfcmVzcG9uc2l2ZSA9IGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICByZXNwb25zaXZlLndpZHRoICAgID0gJHdyYXBwZXIub3V0ZXJXaWR0aCgpO1xuICAgICAgICAgICAgcmVzcG9uc2l2ZS5yYXRpbyAgICA9IHJlc3BvbnNpdmUud2lkdGgvc2V0dGluZ3Mud2lkdGgsXG4gICAgICAgICAgICByZXNwb25zaXZlLmhlaWdodCAgID0gc2V0dGluZ3MuaGVpZ2h0ICogcmVzcG9uc2l2ZS5yYXRpbztcblxuICAgICAgICAgICAgaWYoc2V0dGluZ3MuYW5pbXR5cGUgPT09ICdmYWRlJyl7XG5cbiAgICAgICAgICAgICAgICAvLyBpbml0aWFsIHNldHVwXG4gICAgICAgICAgICAgICAgJHNsaWRlcy5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JyAgICAgICAgOiBzZXR0aW5ncy5oZWlnaHQsXG4gICAgICAgICAgICAgICAgICAgICd3aWR0aCcgICAgICAgICA6ICcxMDAlJ1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICRzbGlkZXMuY2hpbGRyZW4oJ2ltZycpLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICdoZWlnaHQnICAgICAgICA6IHNldHRpbmdzLmhlaWdodCxcbiAgICAgICAgICAgICAgICAgICAgJ3dpZHRoJyAgICAgICAgIDogJzEwMCUnXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgJHNsaWRlci5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JyAgICAgICAgOiBzZXR0aW5ncy5oZWlnaHQsXG4gICAgICAgICAgICAgICAgICAgICd3aWR0aCcgICAgICAgICA6ICcxMDAlJ1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICR3cmFwcGVyLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICdoZWlnaHQnICAgICAgICA6IHNldHRpbmdzLmhlaWdodCxcbiAgICAgICAgICAgICAgICAgICAgJ21heC13aWR0aCcgICAgIDogc2V0dGluZ3Mud2lkdGgsXG4gICAgICAgICAgICAgICAgICAgICdwb3NpdGlvbicgICAgICA6ICdyZWxhdGl2ZSdcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGlmKHJlc3BvbnNpdmUud2lkdGggPCBzZXR0aW5ncy53aWR0aCl7XG5cbiAgICAgICAgICAgICAgICAgICAgJHNsaWRlcy5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCcgICAgICAgIDogcmVzcG9uc2l2ZS5oZWlnaHRcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICRzbGlkZXMuY2hpbGRyZW4oJ2ltZycpLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JyAgICAgICAgOiByZXNwb25zaXZlLmhlaWdodFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgJHNsaWRlci5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCcgICAgICAgIDogcmVzcG9uc2l2ZS5oZWlnaHRcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICR3cmFwcGVyLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JyAgICAgICAgOiByZXNwb25zaXZlLmhlaWdodFxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICQod2luZG93KS5yZXNpemUoZnVuY3Rpb24oKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gY2FsY3VsYXRlIGFuZCB1cGRhdGUgZGltZW5zaW9uc1xuICAgICAgICAgICAgICAgICAgICByZXNwb25zaXZlLndpZHRoICAgID0gJHdyYXBwZXIub3V0ZXJXaWR0aCgpO1xuICAgICAgICAgICAgICAgICAgICByZXNwb25zaXZlLnJhdGlvICAgID0gcmVzcG9uc2l2ZS53aWR0aC9zZXR0aW5ncy53aWR0aCxcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2l2ZS5oZWlnaHQgICA9IHNldHRpbmdzLmhlaWdodCAqIHJlc3BvbnNpdmUucmF0aW87XG5cbiAgICAgICAgICAgICAgICAgICAgJHNsaWRlcy5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCcgICAgICAgIDogcmVzcG9uc2l2ZS5oZWlnaHRcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICRzbGlkZXMuY2hpbGRyZW4oJ2ltZycpLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JyAgICAgICAgOiByZXNwb25zaXZlLmhlaWdodFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgJHNsaWRlci5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCcgICAgICAgIDogcmVzcG9uc2l2ZS5oZWlnaHRcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICR3cmFwcGVyLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JyAgICAgICAgOiByZXNwb25zaXZlLmhlaWdodFxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmKHNldHRpbmdzLmFuaW10eXBlID09PSAnc2xpZGUnKXtcblxuICAgICAgICAgICAgICAgIC8vIGluaXRpYWwgc2V0dXBcbiAgICAgICAgICAgICAgICAkc2xpZGVzLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICdoZWlnaHQnICAgICAgICA6IHNldHRpbmdzLmhlaWdodCxcbiAgICAgICAgICAgICAgICAgICAgJ3dpZHRoJyAgICAgICAgIDogc2V0dGluZ3Mud2lkdGhcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAkc2xpZGVzLmNoaWxkcmVuKCdpbWcnKS5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JyAgICAgICAgOiBzZXR0aW5ncy5oZWlnaHQsXG4gICAgICAgICAgICAgICAgICAgICd3aWR0aCcgICAgICAgICA6IHNldHRpbmdzLndpZHRoXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgJHNsaWRlci5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JyAgICAgICAgOiBzZXR0aW5ncy5oZWlnaHQsXG4gICAgICAgICAgICAgICAgICAgICd3aWR0aCcgICAgICAgICA6IHNldHRpbmdzLndpZHRoICogc2V0dGluZ3Muc2xpZGVjb3VudFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICR3cmFwcGVyLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICdoZWlnaHQnICAgICAgICA6IHNldHRpbmdzLmhlaWdodCxcbiAgICAgICAgICAgICAgICAgICAgJ21heC13aWR0aCcgICAgIDogc2V0dGluZ3Mud2lkdGgsXG4gICAgICAgICAgICAgICAgICAgICdwb3NpdGlvbicgICAgICA6ICdyZWxhdGl2ZSdcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGlmKHJlc3BvbnNpdmUud2lkdGggPCBzZXR0aW5ncy53aWR0aCl7XG5cbiAgICAgICAgICAgICAgICAgICAgJHNsaWRlcy5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCcgICAgICAgIDogcmVzcG9uc2l2ZS5oZWlnaHRcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICRzbGlkZXMuY2hpbGRyZW4oJ2ltZycpLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JyAgICAgICAgOiByZXNwb25zaXZlLmhlaWdodFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgJHNsaWRlci5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCcgICAgICAgIDogcmVzcG9uc2l2ZS5oZWlnaHRcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICR3cmFwcGVyLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JyAgICAgICAgOiByZXNwb25zaXZlLmhlaWdodFxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICQod2luZG93KS5yZXNpemUoZnVuY3Rpb24oKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gY2FsY3VsYXRlIGFuZCB1cGRhdGUgZGltZW5zaW9uc1xuICAgICAgICAgICAgICAgICAgICByZXNwb25zaXZlLndpZHRoICAgID0gJHdyYXBwZXIub3V0ZXJXaWR0aCgpLFxuICAgICAgICAgICAgICAgICAgICByZXNwb25zaXZlLnJhdGlvICAgID0gcmVzcG9uc2l2ZS53aWR0aC9zZXR0aW5ncy53aWR0aCxcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2l2ZS5oZWlnaHQgICA9IHNldHRpbmdzLmhlaWdodCAqIHJlc3BvbnNpdmUucmF0aW87XG5cbiAgICAgICAgICAgICAgICAgICAgJHNsaWRlcy5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCcgICAgICAgIDogcmVzcG9uc2l2ZS5oZWlnaHQsXG4gICAgICAgICAgICAgICAgICAgICAgICAnd2lkdGgnICAgICAgICAgOiByZXNwb25zaXZlLndpZHRoXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAkc2xpZGVzLmNoaWxkcmVuKCdpbWcnKS5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCcgICAgICAgIDogcmVzcG9uc2l2ZS5oZWlnaHQsXG4gICAgICAgICAgICAgICAgICAgICAgICAnd2lkdGgnICAgICAgICAgOiByZXNwb25zaXZlLndpZHRoXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAkc2xpZGVyLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JyAgICAgICAgOiByZXNwb25zaXZlLmhlaWdodCxcbiAgICAgICAgICAgICAgICAgICAgICAgICd3aWR0aCcgICAgICAgICA6IHJlc3BvbnNpdmUud2lkdGggKiBzZXR0aW5ncy5zbGlkZWNvdW50XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAkd3JhcHBlci5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCcgICAgICAgIDogcmVzcG9uc2l2ZS5oZWlnaHRcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICRjYW52YXMuY3NzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICdoZWlnaHQnICAgICAgICA6IHJlc3BvbnNpdmUuaGVpZ2h0LFxuICAgICAgICAgICAgICAgICAgICAgICAgJ3dpZHRoJyAgICAgICAgIDogcmVzcG9uc2l2ZS53aWR0aFxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICByZXNpemVfY29tcGxldGUoZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIGdvKGZhbHNlLHN0YXRlLmN1cnJlbnRzbGlkZSk7XG4gICAgICAgICAgICAgICAgICAgIH0sIDIwMCwgXCJzb21lIHVuaXF1ZSBzdHJpbmdcIik7XG5cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIHJlc2l6ZV9jb21wbGV0ZSA9IChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHZhciB0aW1lcnMgPSB7fTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChjYWxsYmFjaywgbXMsIHVuaXF1ZUlkKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF1bmlxdWVJZCkge1xuICAgICAgICAgICAgICAgICAgICB1bmlxdWVJZCA9IFwiRG9uJ3QgY2FsbCB0aGlzIHR3aWNlIHdpdGhvdXQgYSB1bmlxdWVJZFwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodGltZXJzW3VuaXF1ZUlkXSkge1xuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQgKHRpbWVyc1t1bmlxdWVJZF0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aW1lcnNbdW5pcXVlSWRdID0gc2V0VGltZW91dChjYWxsYmFjaywgbXMpO1xuICAgICAgICAgICAgfTtcblxuICAgICAgICB9KSgpO1xuXG4gICAgICAgIC8vIGVuZm9yY2UgZml4ZWQgc2l6aW5nIG9uIHNsaWRlcywgc2xpZGVyIGFuZCB3cmFwcGVyXG4gICAgICAgIHZhciBjb25mX3N0YXRpYyA9IGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICAkc2xpZGVzLmNzcyh7XG4gICAgICAgICAgICAgICAgJ2hlaWdodCcgICAgOiBzZXR0aW5ncy5oZWlnaHQsXG4gICAgICAgICAgICAgICAgJ3dpZHRoJyAgICAgOiBzZXR0aW5ncy53aWR0aFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAkc2xpZGVyLmNzcyh7XG4gICAgICAgICAgICAgICAgJ2hlaWdodCcgICAgOiBzZXR0aW5ncy5oZWlnaHQsXG4gICAgICAgICAgICAgICAgJ3dpZHRoJyAgICAgOiBzZXR0aW5ncy53aWR0aFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAkd3JhcHBlci5jc3Moe1xuICAgICAgICAgICAgICAgICdoZWlnaHQnICAgIDogc2V0dGluZ3MuaGVpZ2h0LFxuICAgICAgICAgICAgICAgICd3aWR0aCcgICAgIDogc2V0dGluZ3Mud2lkdGgsXG4gICAgICAgICAgICAgICAgJ3Bvc2l0aW9uJyAgOiAncmVsYXRpdmUnXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBjb25mX3NsaWRlID0gZnVuY3Rpb24oKSB7XG5cbiAgICAgICAgICAgIC8vIGNyZWF0ZSB0d28gZXh0cmEgZWxlbWVudHMgd2hpY2ggYXJlIGNsb25lcyBvZiB0aGUgZmlyc3QgYW5kIGxhc3Qgc2xpZGVzXG4gICAgICAgICAgICAkY2xvbmVfZmlyc3QgICAgPSAkc2xpZGVzLmVxKDApLmNsb25lKCk7XG4gICAgICAgICAgICAkY2xvbmVfbGFzdCAgICAgPSAkc2xpZGVzLmVxKHN0YXRlLnNsaWRlY291bnQtMSkuY2xvbmUoKTtcblxuICAgICAgICAgICAgLy8gYWRkIHRoZW0gdG8gdGhlIERPTSB3aGVyZSB3ZSBuZWVkIHRoZW1cbiAgICAgICAgICAgICRjbG9uZV9maXJzdC5hdHRyKHsnZGF0YS1jbG9uZScgOiAnbGFzdCcsICdkYXRhLXNsaWRlJyA6IDB9KS5hcHBlbmRUbygkc2xpZGVyKS5zaG93KCk7XG4gICAgICAgICAgICAkY2xvbmVfbGFzdC5hdHRyKHsnZGF0YS1jbG9uZScgOiAnZmlyc3QnLCAnZGF0YS1zbGlkZScgOiAwfSkucHJlcGVuZFRvKCRzbGlkZXIpLnNob3coKTtcblxuICAgICAgICAgICAgLy8gdXBkYXRlIHRoZSBlbGVtZW50cyBvYmplY3RcbiAgICAgICAgICAgICRzbGlkZXMgICAgICAgICAgICAgPSAkc2xpZGVyLmNoaWxkcmVuKCdsaScpO1xuICAgICAgICAgICAgc3RhdGUuc2xpZGVjb3VudCAgICA9ICRzbGlkZXMubGVuZ3RoO1xuXG4gICAgICAgICAgICAvLyBjcmVhdGUgYSAnY2FudmFzJyBlbGVtZW50IHdoaWNoIGlzIG5lY2Nlc3NhcnkgZm9yIHRoZSBzbGlkZSBhbmltYXRpb24gdG8gd29ya1xuICAgICAgICAgICAgJGNhbnZhcyA9ICQoJzxkaXYgY2xhc3M9XCJianFzLXdyYXBwZXJcIj48L2Rpdj4nKTtcblxuICAgICAgICAgICAgLy8gaWYgdGhlIHNsaWRlciBpcyByZXNwb25zaXZlICYmIHRoZSBjYWxjdWxhdGVkIHdpZHRoIGlzIGxlc3MgdGhhbiB0aGUgbWF4IHdpZHRoXG4gICAgICAgICAgICBpZihzZXR0aW5ncy5yZXNwb25zaXZlICYmIChyZXNwb25zaXZlLndpZHRoIDwgc2V0dGluZ3Mud2lkdGgpKXtcblxuICAgICAgICAgICAgICAgICRjYW52YXMuY3NzKHtcbiAgICAgICAgICAgICAgICAgICAgJ3dpZHRoJyAgICAgOiByZXNwb25zaXZlLndpZHRoLFxuICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JyAgICA6IHJlc3BvbnNpdmUuaGVpZ2h0LFxuICAgICAgICAgICAgICAgICAgICAnb3ZlcmZsb3cnICA6ICdoaWRkZW4nLFxuICAgICAgICAgICAgICAgICAgICAncG9zaXRpb24nICA6ICdyZWxhdGl2ZSdcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSB0aGUgZGltZW5zaW9ucyB0byB0aGUgc2xpZGVyIHRvIGFjY29tb2RhdGUgYWxsIHRoZSBzbGlkZXMgc2lkZSBieSBzaWRlXG4gICAgICAgICAgICAgICAgJHNsaWRlci5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAnd2lkdGgnICAgICA6IHJlc3BvbnNpdmUud2lkdGggKiAoc3RhdGUuc2xpZGVjb3VudCArIDIpLFxuICAgICAgICAgICAgICAgICAgICAnbGVmdCcgICAgICA6IC1yZXNwb25zaXZlLndpZHRoICogc3RhdGUuY3VycmVudHNsaWRlXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuXG4gICAgICAgICAgICAgICAgJGNhbnZhcy5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAnd2lkdGgnICAgICA6IHNldHRpbmdzLndpZHRoLFxuICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JyAgICA6IHNldHRpbmdzLmhlaWdodCxcbiAgICAgICAgICAgICAgICAgICAgJ292ZXJmbG93JyAgOiAnaGlkZGVuJyxcbiAgICAgICAgICAgICAgICAgICAgJ3Bvc2l0aW9uJyAgOiAncmVsYXRpdmUnXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAvLyB1cGRhdGUgdGhlIGRpbWVuc2lvbnMgdG8gdGhlIHNsaWRlciB0byBhY2NvbW9kYXRlIGFsbCB0aGUgc2xpZGVzIHNpZGUgYnkgc2lkZVxuICAgICAgICAgICAgICAgICRzbGlkZXIuY3NzKHtcbiAgICAgICAgICAgICAgICAgICAgJ3dpZHRoJyAgICAgOiBzZXR0aW5ncy53aWR0aCAqIChzdGF0ZS5zbGlkZWNvdW50ICsgMiksXG4gICAgICAgICAgICAgICAgICAgICdsZWZ0JyAgICAgIDogLXNldHRpbmdzLndpZHRoICogc3RhdGUuY3VycmVudHNsaWRlXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gYWRkIHNvbWUgaW5saW5lIHN0eWxlcyB3aGljaCB3aWxsIGFsaWduIG91ciBzbGlkZXMgZm9yIGxlZnQtcmlnaHQgc2xpZGluZ1xuICAgICAgICAgICAgJHNsaWRlcy5jc3Moe1xuICAgICAgICAgICAgICAgICdmbG9hdCcgICAgICAgICA6ICdsZWZ0JyxcbiAgICAgICAgICAgICAgICAncG9zaXRpb24nICAgICAgOiAncmVsYXRpdmUnLFxuICAgICAgICAgICAgICAgICdkaXNwbGF5JyAgICAgICA6ICdsaXN0LWl0ZW0nXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgLy8gJ2V2ZXJ5dGhpbmcuLiBpbiBpdCdzIHJpZ2h0IHBsYWNlJ1xuICAgICAgICAgICAgJGNhbnZhcy5wcmVwZW5kVG8oJHdyYXBwZXIpO1xuICAgICAgICAgICAgJHNsaWRlci5hcHBlbmRUbygkY2FudmFzKTtcblxuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBjb25mX2NvbnRyb2xzID0gZnVuY3Rpb24oKSB7XG5cbiAgICAgICAgICAgIC8vIGNyZWF0ZSB0aGUgZWxlbWVudHMgZm9yIHRoZSBjb250cm9sc1xuICAgICAgICAgICAgJGNfd3JhcHBlciAgPSAkKCc8dWwgY2xhc3M9XCJianFzLWNvbnRyb2xzXCI+PC91bD4nKTtcbiAgICAgICAgICAgICRjX2Z3ZCAgICAgID0gJCgnPGxpIGNsYXNzPVwiYmpxcy1uZXh0XCI+PGEgaHJlZj1cIiNcIiBkYXRhLWRpcmVjdGlvbj1cIicrIHZhcnMuZndkICsnXCI+JyArIHNldHRpbmdzLm5leHR0ZXh0ICsgJzwvYT48L2xpPicpO1xuICAgICAgICAgICAgJGNfcHJldiAgICAgPSAkKCc8bGkgY2xhc3M9XCJianFzLXByZXZcIj48YSBocmVmPVwiI1wiIGRhdGEtZGlyZWN0aW9uPVwiJysgdmFycy5wcmV2ICsnXCI+JyArIHNldHRpbmdzLnByZXZ0ZXh0ICsgJzwvYT48L2xpPicpO1xuXG4gICAgICAgICAgICAvLyBiaW5kIGNsaWNrIGV2ZW50c1xuICAgICAgICAgICAgJGNfd3JhcHBlci5vbignY2xpY2snLCdhJyxmdW5jdGlvbihlKXtcblxuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICB2YXIgZGlyZWN0aW9uID0gJCh0aGlzKS5hdHRyKCdkYXRhLWRpcmVjdGlvbicpO1xuXG4gICAgICAgICAgICAgICAgaWYoIXN0YXRlLmFuaW1hdGluZyl7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYoZGlyZWN0aW9uID09PSB2YXJzLmZ3ZCl7XG4gICAgICAgICAgICAgICAgICAgICAgICBnbyh2YXJzLmZ3ZCxmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZihkaXJlY3Rpb24gPT09IHZhcnMucHJldil7XG4gICAgICAgICAgICAgICAgICAgICAgICBnbyh2YXJzLnByZXYsZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvLyBwdXQgJ2VtIGFsbCB0b2dldGhlclxuICAgICAgICAgICAgJGNfcHJldi5hcHBlbmRUbygkY193cmFwcGVyKTtcbiAgICAgICAgICAgICRjX2Z3ZC5hcHBlbmRUbygkY193cmFwcGVyKTtcbiAgICAgICAgICAgICRjX3dyYXBwZXIuYXBwZW5kVG8oJHdyYXBwZXIpO1xuXG4gICAgICAgICAgICAvLyB2ZXJ0aWNhbGx5IGNlbnRlciB0aGUgY29udHJvbHNcbiAgICAgICAgICAgIGlmIChzZXR0aW5ncy5jZW50ZXJjb250cm9scykge1xuXG4gICAgICAgICAgICAgICAgJGNfd3JhcHBlci5hZGRDbGFzcygndi1jZW50ZXJlZCcpO1xuXG4gICAgICAgICAgICAgICAgLy8gY2FsY3VsYXRlIG9mZnNldCAlIGZvciB2ZXJ0aWNhbCBwb3NpdGlvbmluZ1xuICAgICAgICAgICAgICAgIHZhciBvZmZzZXRfcHggICA9ICgkd3JhcHBlci5oZWlnaHQoKSAtICRjX2Z3ZC5jaGlsZHJlbignYScpLm91dGVySGVpZ2h0KCkpIC8gMixcbiAgICAgICAgICAgICAgICAgICAgcmF0aW8gICAgICAgPSAob2Zmc2V0X3B4IC8gc2V0dGluZ3MuaGVpZ2h0KSAqIDEwMCxcbiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ICAgICAgPSByYXRpbyArICclJztcblxuICAgICAgICAgICAgICAgICRjX2Z3ZC5maW5kKCdhJykuY3NzKCd0b3AnLCBvZmZzZXQpO1xuICAgICAgICAgICAgICAgICRjX3ByZXYuZmluZCgnYScpLmNzcygndG9wJywgb2Zmc2V0KTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGNvbmZfbWFya2VycyA9IGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICAvLyBjcmVhdGUgYSB3cmFwcGVyIGZvciBvdXIgbWFya2Vyc1xuICAgICAgICAgICAgJG1fd3JhcHBlciA9ICQoJzxvbCBjbGFzcz1cImJqcXMtbWFya2Vyc1wiPjwvb2w+Jyk7XG5cbiAgICAgICAgICAgIC8vIGZvciBldmVyeSBzbGlkZSwgY3JlYXRlIGEgbWFya2VyXG4gICAgICAgICAgICAkLmVhY2goJHNsaWRlcywgZnVuY3Rpb24oa2V5LCBzbGlkZSl7XG5cbiAgICAgICAgICAgICAgICB2YXIgc2xpZGVudW0gICAgPSBrZXkgKyAxLFxuICAgICAgICAgICAgICAgICAgICBnb3Rvc2xpZGUgICA9IGtleSArIDE7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYoc2V0dGluZ3MuYW5pbXR5cGUgPT09ICdzbGlkZScpe1xuICAgICAgICAgICAgICAgICAgICAvLyArIDIgdG8gYWNjb3VudCBmb3IgY2xvbmVzXG4gICAgICAgICAgICAgICAgICAgIGdvdG9zbGlkZSA9IGtleSArIDI7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdmFyIG1hcmtlciA9ICQoJzxsaT48YSBocmVmPVwiI1wiPicrIHNsaWRlbnVtICsnPC9hPjwvbGk+Jyk7XG5cbiAgICAgICAgICAgICAgICAvLyBzZXQgdGhlIGZpcnN0IG1hcmtlciB0byBiZSBhY3RpdmVcbiAgICAgICAgICAgICAgICBpZihzbGlkZW51bSA9PT0gc3RhdGUuY3VycmVudHNsaWRlKXsgbWFya2VyLmFkZENsYXNzKCdhY3RpdmUtbWFya2VyJyk7IH1cblxuICAgICAgICAgICAgICAgIC8vIGJpbmQgdGhlIGNsaWNrIGV2ZW50XG4gICAgICAgICAgICAgICAgbWFya2VyLm9uKCdjbGljaycsJ2EnLGZ1bmN0aW9uKGUpe1xuICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgIGlmKCFzdGF0ZS5hbmltYXRpbmcgJiYgc3RhdGUuY3VycmVudHNsaWRlICE9PSBnb3Rvc2xpZGUpe1xuICAgICAgICAgICAgICAgICAgICAgICAgZ28oZmFsc2UsZ290b3NsaWRlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgLy8gYWRkIHRoZSBtYXJrZXIgdG8gdGhlIHdyYXBwZXJcbiAgICAgICAgICAgICAgICBtYXJrZXIuYXBwZW5kVG8oJG1fd3JhcHBlcik7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAkbV93cmFwcGVyLmFwcGVuZFRvKCR3cmFwcGVyKTtcbiAgICAgICAgICAgICRtX21hcmtlcnMgPSAkbV93cmFwcGVyLmZpbmQoJ2xpJyk7XG5cbiAgICAgICAgICAgIC8vIGNlbnRlciB0aGUgbWFya2Vyc1xuICAgICAgICAgICAgaWYgKHNldHRpbmdzLmNlbnRlcm1hcmtlcnMpIHtcbiAgICAgICAgICAgICAgICAkbV93cmFwcGVyLmFkZENsYXNzKCdoLWNlbnRlcmVkJyk7XG4gICAgICAgICAgICAgICAgdmFyIG9mZnNldCA9IChzZXR0aW5ncy53aWR0aCAtICRtX3dyYXBwZXIud2lkdGgoKSkgLyAyO1xuICAgICAgICAgICAgICAgICRtX3dyYXBwZXIuY3NzKCdsZWZ0Jywgb2Zmc2V0KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBjb25mX2tleW5hdiA9IGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICAkKGRvY3VtZW50KS5rZXl1cChmdW5jdGlvbiAoZXZlbnQpIHtcblxuICAgICAgICAgICAgICAgIGlmICghc3RhdGUucGF1c2VkKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoc3RhdGUuaW50ZXJ2YWwpO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wYXVzZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICghc3RhdGUuYW5pbWF0aW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5rZXlDb2RlID09PSAzOSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGdvKHZhcnMuZndkLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnQua2V5Q29kZSA9PT0gMzcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBnbyh2YXJzLnByZXYsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5wYXVzZWQgJiYgc2V0dGluZ3MuYXV0b21hdGljKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLmludGVydmFsID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZ28odmFycy5md2QpO1xuICAgICAgICAgICAgICAgICAgICB9LCBzZXR0aW5ncy5hbmltc3BlZWQpO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGNvbmZfaG92ZXJwYXVzZSA9IGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICAkd3JhcHBlci5ob3ZlcihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS5wYXVzZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChzdGF0ZS5pbnRlcnZhbCk7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnBhdXNlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5wYXVzZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBnbyh2YXJzLmZ3ZCwgZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB9LCBzZXR0aW5ncy5hbmltc3BlZWQpO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBjb25mX2NhcHRpb25zID0gZnVuY3Rpb24oKSB7XG5cbiAgICAgICAgICAgICQuZWFjaCgkc2xpZGVzLCBmdW5jdGlvbiAoa2V5LCBzbGlkZSkge1xuXG4gICAgICAgICAgICAgICAgdmFyIGNhcHRpb24gPSAkKHNsaWRlKS5jaGlsZHJlbignaW1nOmZpcnN0LWNoaWxkJykuYXR0cigndGl0bGUnKTtcblxuICAgICAgICAgICAgICAgIC8vIEFjY291bnQgZm9yIGltYWdlcyB3cmFwcGVkIGluIGxpbmtzXG4gICAgICAgICAgICAgICAgaWYoIWNhcHRpb24pe1xuICAgICAgICAgICAgICAgICAgICBjYXB0aW9uID0gJChzbGlkZSkuY2hpbGRyZW4oJ2EnKS5maW5kKCdpbWc6Zmlyc3QtY2hpbGQnKS5hdHRyKCd0aXRsZScpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChjYXB0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhcHRpb24gPSAkKCc8cCBjbGFzcz1cImJqcXMtY2FwdGlvblwiPicgKyBjYXB0aW9uICsgJzwvcD4nKTtcbiAgICAgICAgICAgICAgICAgICAgY2FwdGlvbi5hcHBlbmRUbygkKHNsaWRlKSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBjb25mX3JhbmRvbSA9IGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICB2YXIgcmFuZCAgICAgICAgICAgID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogc3RhdGUuc2xpZGVjb3VudCkgKyAxO1xuICAgICAgICAgICAgc3RhdGUuY3VycmVudHNsaWRlICA9IHJhbmQ7XG4gICAgICAgICAgICBzdGF0ZS5jdXJyZW50aW5kZXggID0gcmFuZC0xO1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIHNldF9uZXh0ID0gZnVuY3Rpb24oZGlyZWN0aW9uKSB7XG5cbiAgICAgICAgICAgIGlmKGRpcmVjdGlvbiA9PT0gdmFycy5md2Qpe1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmKCRzbGlkZXMuZXEoc3RhdGUuY3VycmVudGluZGV4KS5uZXh0KCkubGVuZ3RoKXtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUubmV4dGluZGV4ID0gc3RhdGUuY3VycmVudGluZGV4ICsgMTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUubmV4dHNsaWRlID0gc3RhdGUuY3VycmVudHNsaWRlICsgMTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUubmV4dGluZGV4ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUubmV4dHNsaWRlID0gMTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2V7XG5cbiAgICAgICAgICAgICAgICBpZigkc2xpZGVzLmVxKHN0YXRlLmN1cnJlbnRpbmRleCkucHJldigpLmxlbmd0aCl7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm5leHRpbmRleCA9IHN0YXRlLmN1cnJlbnRpbmRleCAtIDE7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm5leHRzbGlkZSA9IHN0YXRlLmN1cnJlbnRzbGlkZSAtIDE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm5leHRpbmRleCA9IHN0YXRlLnNsaWRlY291bnQgLSAxO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5uZXh0c2xpZGUgPSBzdGF0ZS5zbGlkZWNvdW50O1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGdvID0gZnVuY3Rpb24oZGlyZWN0aW9uLCBwb3NpdGlvbikge1xuXG4gICAgICAgICAgICAvLyBvbmx5IGlmIHdlJ3JlIG5vdCBhbHJlYWR5IGRvaW5nIHRoaW5nc1xuICAgICAgICAgICAgaWYoIXN0YXRlLmFuaW1hdGluZyl7XG5cbiAgICAgICAgICAgICAgICAvLyBkb2luZyB0aGluZ3NcbiAgICAgICAgICAgICAgICBzdGF0ZS5hbmltYXRpbmcgPSB0cnVlO1xuXG4gICAgICAgICAgICAgICAgaWYocG9zaXRpb24pe1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5uZXh0c2xpZGUgPSBwb3NpdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUubmV4dGluZGV4ID0gcG9zaXRpb24tMTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgc2V0X25leHQoZGlyZWN0aW9uKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvLyBmYWRlIGFuaW1hdGlvblxuICAgICAgICAgICAgICAgIGlmKHNldHRpbmdzLmFuaW10eXBlID09PSAnZmFkZScpe1xuXG4gICAgICAgICAgICAgICAgICAgIGlmKHNldHRpbmdzLnNob3dtYXJrZXJzKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICRtX21hcmtlcnMucmVtb3ZlQ2xhc3MoJ2FjdGl2ZS1tYXJrZXInKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICRtX21hcmtlcnMuZXEoc3RhdGUubmV4dGluZGV4KS5hZGRDbGFzcygnYWN0aXZlLW1hcmtlcicpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gZmFkZSBvdXQgY3VycmVudFxuICAgICAgICAgICAgICAgICAgICAkc2xpZGVzLmVxKHN0YXRlLmN1cnJlbnRpbmRleCkuZmFkZU91dChzZXR0aW5ncy5hbmltZHVyYXRpb24pO1xuICAgICAgICAgICAgICAgICAgICAvLyBmYWRlIGluIG5leHRcbiAgICAgICAgICAgICAgICAgICAgJHNsaWRlcy5lcShzdGF0ZS5uZXh0aW5kZXgpLmZhZGVJbihzZXR0aW5ncy5hbmltZHVyYXRpb24sIGZ1bmN0aW9uKCl7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSBzdGF0ZSB2YXJpYWJsZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmFuaW1hdGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuY3VycmVudHNsaWRlID0gc3RhdGUubmV4dHNsaWRlO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuY3VycmVudGluZGV4ID0gc3RhdGUubmV4dGluZGV4O1xuXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gc2xpZGUgYW5pbWF0aW9uXG4gICAgICAgICAgICAgICAgaWYoc2V0dGluZ3MuYW5pbXR5cGUgPT09ICdzbGlkZScpe1xuXG4gICAgICAgICAgICAgICAgICAgIGlmKHNldHRpbmdzLnNob3dtYXJrZXJzKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1hcmtlcmluZGV4ID0gc3RhdGUubmV4dGluZGV4LTE7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG1hcmtlcmluZGV4ID09PSBzdGF0ZS5zbGlkZWNvdW50LTIpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmtlcmluZGV4ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYobWFya2VyaW5kZXggPT09IC0xKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJrZXJpbmRleCA9IHN0YXRlLnNsaWRlY291bnQtMztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgJG1fbWFya2Vycy5yZW1vdmVDbGFzcygnYWN0aXZlLW1hcmtlcicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJG1fbWFya2Vycy5lcShtYXJrZXJpbmRleCkuYWRkQ2xhc3MoJ2FjdGl2ZS1tYXJrZXInKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBzbGlkZXIgaXMgcmVzcG9uc2l2ZSAmJiB0aGUgY2FsY3VsYXRlZCB3aWR0aCBpcyBsZXNzIHRoYW4gdGhlIG1heCB3aWR0aFxuICAgICAgICAgICAgICAgICAgICBpZihzZXR0aW5ncy5yZXNwb25zaXZlICYmICggcmVzcG9uc2l2ZS53aWR0aCA8IHNldHRpbmdzLndpZHRoICkgKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnNsaWRld2lkdGggPSByZXNwb25zaXZlLndpZHRoO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5zbGlkZXdpZHRoID0gc2V0dGluZ3Mud2lkdGg7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAkc2xpZGVyLmFuaW1hdGUoeydsZWZ0JzogLXN0YXRlLm5leHRpbmRleCAqIHN0YXRlLnNsaWRld2lkdGggfSwgc2V0dGluZ3MuYW5pbWR1cmF0aW9uLCBmdW5jdGlvbigpe1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5jdXJyZW50c2xpZGUgPSBzdGF0ZS5uZXh0c2xpZGU7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5jdXJyZW50aW5kZXggPSBzdGF0ZS5uZXh0aW5kZXg7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlzIHRoZSBjdXJyZW50IHNsaWRlIGEgY2xvbmU/XG4gICAgICAgICAgICAgICAgICAgICAgICBpZigkc2xpZGVzLmVxKHN0YXRlLmN1cnJlbnRpbmRleCkuYXR0cignZGF0YS1jbG9uZScpID09PSAnbGFzdCcpe1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWZmaXJtYXRpdmUsIGF0IHRoZSBsYXN0IHNsaWRlIChjbG9uZSBvZiBmaXJzdClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2xpZGVyLmNzcyh7J2xlZnQnOiAtc3RhdGUuc2xpZGV3aWR0aCB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5jdXJyZW50c2xpZGUgPSAyO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmN1cnJlbnRpbmRleCA9IDE7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYoJHNsaWRlcy5lcShzdGF0ZS5jdXJyZW50aW5kZXgpLmF0dHIoJ2RhdGEtY2xvbmUnKSA9PT0gJ2ZpcnN0Jyl7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhZmZpcm1hdGl2ZSwgYXQgdGhlIGZpc3Qgc2xpZGUgKGNsb25lIG9mIGxhc3QpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNsaWRlci5jc3MoeydsZWZ0JzogLXN0YXRlLnNsaWRld2lkdGggKihzdGF0ZS5zbGlkZWNvdW50IC0gMil9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5jdXJyZW50c2xpZGUgPSBzdGF0ZS5zbGlkZWNvdW50IC0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5jdXJyZW50aW5kZXggPSBzdGF0ZS5zbGlkZWNvdW50IC0gMjtcblxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5hbmltYXRpbmcgPSBmYWxzZTtcblxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gbGV0cyBnZXQgdGhlIHBhcnR5IHN0YXJ0ZWQgOilcbiAgICAgICAgaW5pdCgpO1xuXG4gICAgfTtcblxufSkoalF1ZXJ5KTtcbiJdLCJmaWxlIjoiYmpxcy0xLjMubWluLmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
