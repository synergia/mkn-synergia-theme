// main.js //
// Wszystko wrzucamy tu

jQuery(function($) {

  // Dropdown download button //
  // http://codepen.io/georgehastings/pen/vptdb
  $(".dropdown").on("click", function(event) {
    $(this).toggleClass("flip");
    event.stopPropagation();
    console.info("Dropdown-download opened");
  });
  $(document).on("click", function(event) {
    $(".dropdown").removeClass("flip");
  });

  /**
   * Dropy
   * http://codepen.io/Tombek/pen/OPvpLe
   */
  var dropy = {
    $dropys: null,
    openClass: 'open',
    selectClass: 'selected',
    init: function(){
      var self = this;
  
      self.$dropys = $('.dropy');
      self.eventHandler();
    },
    eventHandler: function(){
      var self = this;
  
      // Opening a dropy
      self.$dropys.find('.dropy__title').click(function(){
        self.$dropys.removeClass(self.openClass);
        $(this).parents('.dropy').addClass(self.openClass);
      });
  
      // Click on a dropy list
      self.$dropys.find('.dropy__content ul li a').click(function(){
        var $that = $(this);
        var $dropy = $that.parents('.dropy');
        var $input = $dropy.find('input');
        var $title = $(this).parents('.dropy').find('.dropy__title span');
  
        // Remove selected class
        $dropy.find('.dropy__content a').each(function(){
          $(this).removeClass(self.selectClass);
        });
  
        // Update selected value
        $title.html($that.html());
        $input.val($that.attr('data-value')).trigger('change');
  
        // If back to default, remove selected class else addclass on right element
        if($that.hasClass('dropy__header')){
          $title.removeClass(self.selectClass);
          $title.html($title.attr('data-title'));
        }
        else{
          $title.addClass(self.selectClass);
          $that.addClass(self.selectClass);
        }
  
        // Close dropdown
        $dropy.removeClass(self.openClass);
      });
  
      // Close all dropdown onclick on another element
      $(document).bind('click', function(e){
          if (! $(e.target).parents().hasClass('dropy')){ self.$dropys.removeClass(self.openClass); }
      });
    }
  };
  
  $(function(){
    dropy.init();
  });

    function acts() {
      var te;
      var min = $('.post-list-item-content h2').height();
      $('.post-list-item .post-list-item-content h2').each(function() {
        if ($(this).height() < min)
          min = $(this).height();
      });
  
      $('.post-list-item-content h2').each(function() {
        if ($(this).height() == min) {
          te = $(this).parent().parent().children('.excerpt');
          $(te).text(function(index, currentText) {
            if (currentText.substr(currentText.length - 3) != '\u2026')
              return currentText.substr(0, 150) + '\u2026';
          });
        } else if (($(this).height() < (min - 1) * 3) && ($(this).height() > min)) {
          te = $(this).parent().parent().children('.excerpt');
          $(te).text(function(index, currentText) {
            return currentText.substr(0, 80) + '\u2026';
          });
        } else {
          te = $(this).parent().parent().children('.excerpt');
          $(this).text(function(index, currentText) {
            if ((currentText.substr(currentText.length - 3) != '\u2026') && (currentText.length > 120))
              return currentText.substr(0, 120) + '\u2026';
          });
          te.css("display", "none");
        }
      });
    }
    acts();
    $(window).resize(acts);
  
     function cardExcerpt() {
      $(".card .excerpt").text(function(index, currentText) {
        return currentText.substr(0, 140) + '\u2026';
      });
    }
    cardExcerpt();

  // Pakuje mniejsze obrazki bez podpisu w <figure> //
  // Jeśli obrazek ma tytuł, tym się zajmuje php funkcja w project-functions.php
  $('.project-content p').each(function(index) {
    var some_img = $(this).find('img');
    var width = some_img.width();
    if (width < 980) {
      some_img.wrap("<figure></figure>");
    }
  });

  //Skraca imiona, by nie wychodziły za bloki
  $('.co-author h3 a').each(function(index) {
    var length = $(this).html().length;
    if (length > 13) {
      var name = $(this).text();
      // console.log(name);
      var trimmed_name = name.charAt(0) + ". " + name.substr(name.indexOf(' ') + 1);
      // console.log(trimmed_name);
      $(this).text(trimmed_name);
    }
  });

  // Notyfikacje, powiadomienia //
  $(".note-close").click(function() {
    $(this).parent()
      .animate({
        opacity: 0
      }, 250, function() {
        $(this)
          .animate({
            marginBottom: 0
          }, 250)
          .children()
          .animate({
            padding: 0
          }, 250)
          .wrapInner("<div />")
          .children()
          .slideUp(250, function() {
            $(this).closest(".note").remove();
          });
      });
  });

  // Animacje dla banera rekrutacji //
  $('label.button').on('click', function() {
    $('.fb').addClass('animated fadeInUp');
    $('.date .icon-container').addClass('animated slideInLeft');
    $('.date span').addClass('animated slideInLeft');
    $('.location .icon-container').addClass('animated slideInRight');
    $('.location span').addClass('animated slideInRight');
  
  });
  $('#close_banner').on('click', function() {
    $('.fb').removeClass('animated fadeInUp');
    $('.date .icon-container').removeClass('animated slideInLeft');
    $('.date span').removeClass('animated slideInLeft');
    $('.location .icon-container').removeClass('animated slideInRight');
    $('.location span').removeClass('animated slideInRight');
  });
  
  // http://stackoverflow.com/questions/24070627/create-dropdown-banner-when-user-first-visits-website
  // Pozwalają otwierać baner tylko przy pierwszej wizycie
  
  // cookie-js

  
    $(function() {
      // Touch ripple effect on buttons
      $('.button:not(.button.disabled)').on('click',
  
        function(e) {
  
          /*!
          SVG version for ripple effect via Jonathan Cutrell (gently modified)
          http://webdesign.tutsplus.com/tutorials/recreating-the-touch-ripple-effect-as-seen-on-google-design--cms-21655
          */
  
          var x = e.pageX;
          var y = e.pageY;
          var clickY = y - $(this).offset().top;
          var clickX = x - $(this).offset().left;
          var box = this;
  
          var setX = parseInt(clickX);
          var setY = parseInt(clickY);
          var ripple = '<svg class="ink"><circle cx="' + setX + '" cy="' + setY + '" r="' + 0 + '"></circle></svg>';
  
          $(this).find('.ink').remove();
          $(this).append(ripple);
  
          var c = $(box).find('circle');
          c.animate({
            'r': $(box).outerWidth()
          }, {
            duration: 333,
            step: function(val) {
              c.attr('r', val);
            },
            complete: function() {
              c.fadeOut('fast');
            }
          });
  
          return true;
  
        });
  
    });

  // Pobieranie nicków z url i wyświetlanie ich koło ikon społecznościowych
  // oraz wykorzystanie username'u githuba do wyświetlenia ostatnie aktywności
  $('.userinfo a').each(function(index) {
    var profile = $(this).attr('href');
    var github_profile = profile.substr(19);
    if (profile.indexOf('github') > -1) {
      $('a[data-github]').append(github_profile);
      Github.onlyuserActivity({
        username: github_profile,
        selector: ".github",
        limit: 10
      });
    }
    if (profile.indexOf('twitter') > -1) {
      $('a[data-twitter]').append(profile.substr(20));
    }
    if (profile.indexOf('facebook') > -1) {
      $('a[data-facebook]').append(profile.substr(25));
    }
  });
  
  // Github.onlyuserActivity({
  //   username: "synergia",
  //   selector: ".github_s",
  //   limit: 5
  // });

  function tabs(bLazy) {
    // set active radio to address bar
    $(document).on('click', '.tabs .tabs-nav label', function() {
      var tab_nr = $(this).attr('for');
      var hash = '#' + tab_nr;
      window.history.replaceState('', '', hash);
      if(tab_nr === 'tab-1'){
        bLazy.load($('.tab:nth-of-type(1) .blazy'), true);
      } else if (tab_nr === 'tab-2') {
        bLazy.load($('.tab:nth-of-type(2) .blazy'), true);
      }else if (tab_nr === 'tab-3') {
        bLazy.load($('.tab:nth-of-type(3) .blazy'), true);
      }
  
    });
    // select active radio based on hash
    $(document.location.hash).prop('checked', true);
  }

  /* ========================================================================
   * Bootstrap: transition.js v3.3.6
   * http://getbootstrap.com/javascript/#transitions
   * ========================================================================
   * Copyright 2011-2015 Twitter, Inc.
   * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
   * ======================================================================== */
  
  
  +function ($) {
    'use strict';
  
    // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
    // ============================================================
  
    function transitionEnd() {
      var el = document.createElement('bootstrap')
  
      var transEndEventNames = {
        WebkitTransition : 'webkitTransitionEnd',
        MozTransition    : 'transitionend',
        OTransition      : 'oTransitionEnd otransitionend',
        transition       : 'transitionend'
      }
  
      for (var name in transEndEventNames) {
        if (el.style[name] !== undefined) {
          return { end: transEndEventNames[name] }
        }
      }
  
      return false // explicit for ie8 (  ._.)
    }
  
    // http://blog.alexmaccaw.com/css-transitions
    $.fn.emulateTransitionEnd = function (duration) {
      var called = false
      var $el = this
      $(this).one('bsTransitionEnd', function () { called = true })
      var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
      setTimeout(callback, duration)
      return this
    }
  
    $(function () {
      $.support.transition = transitionEnd()
  
      if (!$.support.transition) return
  
      $.event.special.bsTransitionEnd = {
        bindType: $.support.transition.end,
        delegateType: $.support.transition.end,
        handle: function (e) {
          if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
        }
      }
    })
  
  }(jQuery);

  $(document).ready(function(){
      $("#nav-mobile").html($("#nav-main").html());
      $("#nav-trigger .navicon-button").click(function(){
        console.info('Burger clicked');
          if ($("nav#nav-mobile ul").hasClass("expanded")) {
              $("nav#nav-mobile ul.expanded").removeClass("expanded").slideUp(250);
              $(this).removeClass("open");
          } else {
              $("nav#nav-mobile ul").addClass("expanded").slideDown(250);
              $(this).addClass("open");
          }
      });
  });

  $(document).ready(function() {
    Slider = $('#slider').Swipe({
      auto: 0,
      continuous: true,
    }).data('Swipe');
    if (Slider) {
      $('.next').on('click', Slider.next);
      $('.prev').on('click', Slider.prev);
    }
  });

  // Płynne skrolowanie //
  // https://css-tricks.com/snippets/jquery/smooth-scrolling/#comment-197181
  
  jQuery(function($) {
    $('a[href*=#]:not([href=#])').click(function() {
      if (location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '') || location.hostname == this.hostname) {
  
        var target = $(this.hash);
        target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
        if (target.length) {
          $('html,body').animate({
            scrollTop: target.offset().top
          }, 1000);
          return false;
        }
      }
    });
  });

  /**
   * Created by plks on 2016-03-09.
   */
  
  $('document').ready(function () {
      var tags = Array('robots', 'scifi', 'sci_fi', 'robot', 'electronics', 'code');
      $.get('http://api.giphy.com/v1/gifs/random', {
          'api_key': 'dc6zaTOxFJmzC',
          'tag': tags[Math.floor(Math.random() * tags.length)]
      }, function (data) {
          //console.log('data ' + data.url);
          $('.gif').html('<img src="' + data.data.image_original_url + '" height="100%" width="100%"></img>');
      });
  
  });

  $(document).ready(function() {

      var bLazy = new Blazy({
        offset: 20,
        selector: '.blazy',
        loadInvisible: false,
        breakpoints: [{
          width: 360, // Max-width
          src: 'data-src-small'
        }],
        success: function(element) {
          $(element).parent().removeClass('loading', 500);
          updateCounter();
        },
        error: function(element, msg) {
          if (msg === 'missing') {
            $(element).parent().removeClass('loading', 500); // Data-src is missing
            console.error("bLazy: data-src is missing");
          } else if (msg === 'invalid') {
            $(element).parent().removeClass('loading', 500);
            // Data-src is invalid
            console.error("bLazy: data-src is invalid");
    
          }
        }
      });
      // not needed, only here to illustrate amount of loaded images
      var imageLoaded = 0;
    
      function updateCounter() {
        imageLoaded++;
        console.info("bLazy: Images loaded: %d", imageLoaded);
      }
    
      tabs(bLazy);

    // http://arresteddeveloper.net/wordpress-infinite-scroll-with-wordpress-posts-and-waypoints-js/
    
    // Chyba z tego zrobić należy objekt
    
    var project_status = jQuery('#finished_projects').attr('data-projects-status');
    var ajax_url = jQuery('#projects').attr('data-ajax-url');
    var total_finished_projects = jQuery('#finished_projects').attr('data-total-finished-projects');
    var total_in_progress_projects = jQuery('#in_progress_projects').attr('data-total-in-progress-projects');
    var total_ideas_projects = jQuery('#ideas_projects').attr('data-total-ideas-projects');
    var post_offset = 0;
    var loaded_finished_projects = 0;
    
    // Skrolujemy do stopki, wtedy uruchamia się funkcja loadProjects()
    if (ajax_url) {
      $(window).scroll(function() {
        if ($(window).scrollTop() >= $(document).height() - $(window).height() - 100) {
          if ($('#ideas_projects').is(':visible')) {
            loaded_ideas_projects = $('#ideas_projects').children().length;
            loadProjects('ideas', total_ideas_projects, loaded_ideas_projects);
          }
          else if ($('#in_progress_projects').is(':visible')) {
            loaded_in_progress_projects = $('#in_progress_projects').children().length;
            loadProjects('in_progress', total_in_progress_projects, loaded_in_progress_projects);
          }
          else if ($('#finished_projects').is(':visible')) {
            loaded_finished_projects = $('#finished_projects').children().length;
            loadProjects('finished', total_finished_projects, loaded_finished_projects);
          }
        }
      });
    }
    
    
    function loadProjects(projects_status, total_projects, loaded_projects) {
      post_offset = parseInt(post_offset) + 6;
      console.info("Loaded %s projects: %d/%d",projects_status, loaded_projects, total_projects);
    
      if (total_projects > loaded_projects) {
        $('.loader').show();
        $.ajax({
          url: ajax_url,
          type: 'POST',
          data: {
            action: 'load_projects',
            post_offset: post_offset,
            projects_status: projects_status,
          },
          success: function(data) {
            $('#' + projects_status + '_projects').append(data);
            // $(data).hide().appendTo('#' + projects_status + '_projects').show(200);
            console.info('Ajax: Loaded more %s projects', projects_status);
            bLazy.revalidate();
            cardExcerpt();
            $('.loader').hide();
          }
        });
      } else {
        return false;
      }
    }

  });
  // Prezes zawsze na pierwszym miejscu //
  $('#management_board li#admin').insertBefore('#management_board li:eq(0)');
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJtYWluLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIG1haW4uanMgLy9cclxuLy8gV3N6eXN0a28gd3J6dWNhbXkgdHVcclxuXHJcbmpRdWVyeShmdW5jdGlvbigkKSB7XHJcblxyXG4gIC8vIERyb3Bkb3duIGRvd25sb2FkIGJ1dHRvbiAvL1xyXG4gIC8vIGh0dHA6Ly9jb2RlcGVuLmlvL2dlb3JnZWhhc3RpbmdzL3Blbi92cHRkYlxyXG4gICQoXCIuZHJvcGRvd25cIikub24oXCJjbGlja1wiLCBmdW5jdGlvbihldmVudCkge1xyXG4gICAgJCh0aGlzKS50b2dnbGVDbGFzcyhcImZsaXBcIik7XHJcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgIGNvbnNvbGUuaW5mbyhcIkRyb3Bkb3duLWRvd25sb2FkIG9wZW5lZFwiKTtcclxuICB9KTtcclxuICAkKGRvY3VtZW50KS5vbihcImNsaWNrXCIsIGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAkKFwiLmRyb3Bkb3duXCIpLnJlbW92ZUNsYXNzKFwiZmxpcFwiKTtcclxuICB9KTtcclxuXHJcbiAgLyoqXHJcbiAgICogRHJvcHlcclxuICAgKiBodHRwOi8vY29kZXBlbi5pby9Ub21iZWsvcGVuL09QdnBMZVxyXG4gICAqL1xyXG4gIHZhciBkcm9weSA9IHtcclxuICAgICRkcm9weXM6IG51bGwsXHJcbiAgICBvcGVuQ2xhc3M6ICdvcGVuJyxcclxuICAgIHNlbGVjdENsYXNzOiAnc2VsZWN0ZWQnLFxyXG4gICAgaW5pdDogZnVuY3Rpb24oKXtcclxuICAgICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gIFxyXG4gICAgICBzZWxmLiRkcm9weXMgPSAkKCcuZHJvcHknKTtcclxuICAgICAgc2VsZi5ldmVudEhhbmRsZXIoKTtcclxuICAgIH0sXHJcbiAgICBldmVudEhhbmRsZXI6IGZ1bmN0aW9uKCl7XHJcbiAgICAgIHZhciBzZWxmID0gdGhpcztcclxuICBcclxuICAgICAgLy8gT3BlbmluZyBhIGRyb3B5XHJcbiAgICAgIHNlbGYuJGRyb3B5cy5maW5kKCcuZHJvcHlfX3RpdGxlJykuY2xpY2soZnVuY3Rpb24oKXtcclxuICAgICAgICBzZWxmLiRkcm9weXMucmVtb3ZlQ2xhc3Moc2VsZi5vcGVuQ2xhc3MpO1xyXG4gICAgICAgICQodGhpcykucGFyZW50cygnLmRyb3B5JykuYWRkQ2xhc3Moc2VsZi5vcGVuQ2xhc3MpO1xyXG4gICAgICB9KTtcclxuICBcclxuICAgICAgLy8gQ2xpY2sgb24gYSBkcm9weSBsaXN0XHJcbiAgICAgIHNlbGYuJGRyb3B5cy5maW5kKCcuZHJvcHlfX2NvbnRlbnQgdWwgbGkgYScpLmNsaWNrKGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgdmFyICR0aGF0ID0gJCh0aGlzKTtcclxuICAgICAgICB2YXIgJGRyb3B5ID0gJHRoYXQucGFyZW50cygnLmRyb3B5Jyk7XHJcbiAgICAgICAgdmFyICRpbnB1dCA9ICRkcm9weS5maW5kKCdpbnB1dCcpO1xyXG4gICAgICAgIHZhciAkdGl0bGUgPSAkKHRoaXMpLnBhcmVudHMoJy5kcm9weScpLmZpbmQoJy5kcm9weV9fdGl0bGUgc3BhbicpO1xyXG4gIFxyXG4gICAgICAgIC8vIFJlbW92ZSBzZWxlY3RlZCBjbGFzc1xyXG4gICAgICAgICRkcm9weS5maW5kKCcuZHJvcHlfX2NvbnRlbnQgYScpLmVhY2goZnVuY3Rpb24oKXtcclxuICAgICAgICAgICQodGhpcykucmVtb3ZlQ2xhc3Moc2VsZi5zZWxlY3RDbGFzcyk7XHJcbiAgICAgICAgfSk7XHJcbiAgXHJcbiAgICAgICAgLy8gVXBkYXRlIHNlbGVjdGVkIHZhbHVlXHJcbiAgICAgICAgJHRpdGxlLmh0bWwoJHRoYXQuaHRtbCgpKTtcclxuICAgICAgICAkaW5wdXQudmFsKCR0aGF0LmF0dHIoJ2RhdGEtdmFsdWUnKSkudHJpZ2dlcignY2hhbmdlJyk7XHJcbiAgXHJcbiAgICAgICAgLy8gSWYgYmFjayB0byBkZWZhdWx0LCByZW1vdmUgc2VsZWN0ZWQgY2xhc3MgZWxzZSBhZGRjbGFzcyBvbiByaWdodCBlbGVtZW50XHJcbiAgICAgICAgaWYoJHRoYXQuaGFzQ2xhc3MoJ2Ryb3B5X19oZWFkZXInKSl7XHJcbiAgICAgICAgICAkdGl0bGUucmVtb3ZlQ2xhc3Moc2VsZi5zZWxlY3RDbGFzcyk7XHJcbiAgICAgICAgICAkdGl0bGUuaHRtbCgkdGl0bGUuYXR0cignZGF0YS10aXRsZScpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZXtcclxuICAgICAgICAgICR0aXRsZS5hZGRDbGFzcyhzZWxmLnNlbGVjdENsYXNzKTtcclxuICAgICAgICAgICR0aGF0LmFkZENsYXNzKHNlbGYuc2VsZWN0Q2xhc3MpO1xyXG4gICAgICAgIH1cclxuICBcclxuICAgICAgICAvLyBDbG9zZSBkcm9wZG93blxyXG4gICAgICAgICRkcm9weS5yZW1vdmVDbGFzcyhzZWxmLm9wZW5DbGFzcyk7XHJcbiAgICAgIH0pO1xyXG4gIFxyXG4gICAgICAvLyBDbG9zZSBhbGwgZHJvcGRvd24gb25jbGljayBvbiBhbm90aGVyIGVsZW1lbnRcclxuICAgICAgJChkb2N1bWVudCkuYmluZCgnY2xpY2snLCBmdW5jdGlvbihlKXtcclxuICAgICAgICAgIGlmICghICQoZS50YXJnZXQpLnBhcmVudHMoKS5oYXNDbGFzcygnZHJvcHknKSl7IHNlbGYuJGRyb3B5cy5yZW1vdmVDbGFzcyhzZWxmLm9wZW5DbGFzcyk7IH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfTtcclxuICBcclxuICAkKGZ1bmN0aW9uKCl7XHJcbiAgICBkcm9weS5pbml0KCk7XHJcbiAgfSk7XHJcblxyXG4gICAgZnVuY3Rpb24gYWN0cygpIHtcclxuICAgICAgdmFyIHRlO1xyXG4gICAgICB2YXIgbWluID0gJCgnLnBvc3QtbGlzdC1pdGVtLWNvbnRlbnQgaDInKS5oZWlnaHQoKTtcclxuICAgICAgJCgnLnBvc3QtbGlzdC1pdGVtIC5wb3N0LWxpc3QtaXRlbS1jb250ZW50IGgyJykuZWFjaChmdW5jdGlvbigpIHtcclxuICAgICAgICBpZiAoJCh0aGlzKS5oZWlnaHQoKSA8IG1pbilcclxuICAgICAgICAgIG1pbiA9ICQodGhpcykuaGVpZ2h0KCk7XHJcbiAgICAgIH0pO1xyXG4gIFxyXG4gICAgICAkKCcucG9zdC1saXN0LWl0ZW0tY29udGVudCBoMicpLmVhY2goZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgaWYgKCQodGhpcykuaGVpZ2h0KCkgPT0gbWluKSB7XHJcbiAgICAgICAgICB0ZSA9ICQodGhpcykucGFyZW50KCkucGFyZW50KCkuY2hpbGRyZW4oJy5leGNlcnB0Jyk7XHJcbiAgICAgICAgICAkKHRlKS50ZXh0KGZ1bmN0aW9uKGluZGV4LCBjdXJyZW50VGV4dCkge1xyXG4gICAgICAgICAgICBpZiAoY3VycmVudFRleHQuc3Vic3RyKGN1cnJlbnRUZXh0Lmxlbmd0aCAtIDMpICE9ICdcXHUyMDI2JylcclxuICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFRleHQuc3Vic3RyKDAsIDE1MCkgKyAnXFx1MjAyNic7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2UgaWYgKCgkKHRoaXMpLmhlaWdodCgpIDwgKG1pbiAtIDEpICogMykgJiYgKCQodGhpcykuaGVpZ2h0KCkgPiBtaW4pKSB7XHJcbiAgICAgICAgICB0ZSA9ICQodGhpcykucGFyZW50KCkucGFyZW50KCkuY2hpbGRyZW4oJy5leGNlcnB0Jyk7XHJcbiAgICAgICAgICAkKHRlKS50ZXh0KGZ1bmN0aW9uKGluZGV4LCBjdXJyZW50VGV4dCkge1xyXG4gICAgICAgICAgICByZXR1cm4gY3VycmVudFRleHQuc3Vic3RyKDAsIDgwKSArICdcXHUyMDI2JztcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0ZSA9ICQodGhpcykucGFyZW50KCkucGFyZW50KCkuY2hpbGRyZW4oJy5leGNlcnB0Jyk7XHJcbiAgICAgICAgICAkKHRoaXMpLnRleHQoZnVuY3Rpb24oaW5kZXgsIGN1cnJlbnRUZXh0KSB7XHJcbiAgICAgICAgICAgIGlmICgoY3VycmVudFRleHQuc3Vic3RyKGN1cnJlbnRUZXh0Lmxlbmd0aCAtIDMpICE9ICdcXHUyMDI2JykgJiYgKGN1cnJlbnRUZXh0Lmxlbmd0aCA+IDEyMCkpXHJcbiAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRUZXh0LnN1YnN0cigwLCAxMjApICsgJ1xcdTIwMjYnO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICB0ZS5jc3MoXCJkaXNwbGF5XCIsIFwibm9uZVwiKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgYWN0cygpO1xyXG4gICAgJCh3aW5kb3cpLnJlc2l6ZShhY3RzKTtcclxuICBcclxuICAgICBmdW5jdGlvbiBjYXJkRXhjZXJwdCgpIHtcclxuICAgICAgJChcIi5jYXJkIC5leGNlcnB0XCIpLnRleHQoZnVuY3Rpb24oaW5kZXgsIGN1cnJlbnRUZXh0KSB7XHJcbiAgICAgICAgcmV0dXJuIGN1cnJlbnRUZXh0LnN1YnN0cigwLCAxNDApICsgJ1xcdTIwMjYnO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIGNhcmRFeGNlcnB0KCk7XHJcblxyXG4gIC8vIFBha3VqZSBtbmllanN6ZSBvYnJhemtpIGJleiBwb2RwaXN1IHcgPGZpZ3VyZT4gLy9cclxuICAvLyBKZcWbbGkgb2JyYXplayBtYSB0eXR1xYIsIHR5bSBzacSZIHpham11amUgcGhwIGZ1bmtjamEgdyBwcm9qZWN0LWZ1bmN0aW9ucy5waHBcclxuICAkKCcucHJvamVjdC1jb250ZW50IHAnKS5lYWNoKGZ1bmN0aW9uKGluZGV4KSB7XHJcbiAgICB2YXIgc29tZV9pbWcgPSAkKHRoaXMpLmZpbmQoJ2ltZycpO1xyXG4gICAgdmFyIHdpZHRoID0gc29tZV9pbWcud2lkdGgoKTtcclxuICAgIGlmICh3aWR0aCA8IDk4MCkge1xyXG4gICAgICBzb21lX2ltZy53cmFwKFwiPGZpZ3VyZT48L2ZpZ3VyZT5cIik7XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gIC8vU2tyYWNhIGltaW9uYSwgYnkgbmllIHd5Y2hvZHppxYJ5IHphIGJsb2tpXHJcbiAgJCgnLmNvLWF1dGhvciBoMyBhJykuZWFjaChmdW5jdGlvbihpbmRleCkge1xyXG4gICAgdmFyIGxlbmd0aCA9ICQodGhpcykuaHRtbCgpLmxlbmd0aDtcclxuICAgIGlmIChsZW5ndGggPiAxMykge1xyXG4gICAgICB2YXIgbmFtZSA9ICQodGhpcykudGV4dCgpO1xyXG4gICAgICAvLyBjb25zb2xlLmxvZyhuYW1lKTtcclxuICAgICAgdmFyIHRyaW1tZWRfbmFtZSA9IG5hbWUuY2hhckF0KDApICsgXCIuIFwiICsgbmFtZS5zdWJzdHIobmFtZS5pbmRleE9mKCcgJykgKyAxKTtcclxuICAgICAgLy8gY29uc29sZS5sb2codHJpbW1lZF9uYW1lKTtcclxuICAgICAgJCh0aGlzKS50ZXh0KHRyaW1tZWRfbmFtZSk7XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gIC8vIE5vdHlmaWthY2plLCBwb3dpYWRvbWllbmlhIC8vXHJcbiAgJChcIi5ub3RlLWNsb3NlXCIpLmNsaWNrKGZ1bmN0aW9uKCkge1xyXG4gICAgJCh0aGlzKS5wYXJlbnQoKVxyXG4gICAgICAuYW5pbWF0ZSh7XHJcbiAgICAgICAgb3BhY2l0eTogMFxyXG4gICAgICB9LCAyNTAsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICQodGhpcylcclxuICAgICAgICAgIC5hbmltYXRlKHtcclxuICAgICAgICAgICAgbWFyZ2luQm90dG9tOiAwXHJcbiAgICAgICAgICB9LCAyNTApXHJcbiAgICAgICAgICAuY2hpbGRyZW4oKVxyXG4gICAgICAgICAgLmFuaW1hdGUoe1xyXG4gICAgICAgICAgICBwYWRkaW5nOiAwXHJcbiAgICAgICAgICB9LCAyNTApXHJcbiAgICAgICAgICAud3JhcElubmVyKFwiPGRpdiAvPlwiKVxyXG4gICAgICAgICAgLmNoaWxkcmVuKClcclxuICAgICAgICAgIC5zbGlkZVVwKDI1MCwgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICQodGhpcykuY2xvc2VzdChcIi5ub3RlXCIpLnJlbW92ZSgpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICAvLyBBbmltYWNqZSBkbGEgYmFuZXJhIHJla3J1dGFjamkgLy9cclxuICAkKCdsYWJlbC5idXR0b24nKS5vbignY2xpY2snLCBmdW5jdGlvbigpIHtcclxuICAgICQoJy5mYicpLmFkZENsYXNzKCdhbmltYXRlZCBmYWRlSW5VcCcpO1xyXG4gICAgJCgnLmRhdGUgLmljb24tY29udGFpbmVyJykuYWRkQ2xhc3MoJ2FuaW1hdGVkIHNsaWRlSW5MZWZ0Jyk7XHJcbiAgICAkKCcuZGF0ZSBzcGFuJykuYWRkQ2xhc3MoJ2FuaW1hdGVkIHNsaWRlSW5MZWZ0Jyk7XHJcbiAgICAkKCcubG9jYXRpb24gLmljb24tY29udGFpbmVyJykuYWRkQ2xhc3MoJ2FuaW1hdGVkIHNsaWRlSW5SaWdodCcpO1xyXG4gICAgJCgnLmxvY2F0aW9uIHNwYW4nKS5hZGRDbGFzcygnYW5pbWF0ZWQgc2xpZGVJblJpZ2h0Jyk7XHJcbiAgXHJcbiAgfSk7XHJcbiAgJCgnI2Nsb3NlX2Jhbm5lcicpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCkge1xyXG4gICAgJCgnLmZiJykucmVtb3ZlQ2xhc3MoJ2FuaW1hdGVkIGZhZGVJblVwJyk7XHJcbiAgICAkKCcuZGF0ZSAuaWNvbi1jb250YWluZXInKS5yZW1vdmVDbGFzcygnYW5pbWF0ZWQgc2xpZGVJbkxlZnQnKTtcclxuICAgICQoJy5kYXRlIHNwYW4nKS5yZW1vdmVDbGFzcygnYW5pbWF0ZWQgc2xpZGVJbkxlZnQnKTtcclxuICAgICQoJy5sb2NhdGlvbiAuaWNvbi1jb250YWluZXInKS5yZW1vdmVDbGFzcygnYW5pbWF0ZWQgc2xpZGVJblJpZ2h0Jyk7XHJcbiAgICAkKCcubG9jYXRpb24gc3BhbicpLnJlbW92ZUNsYXNzKCdhbmltYXRlZCBzbGlkZUluUmlnaHQnKTtcclxuICB9KTtcclxuICBcclxuICAvLyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzI0MDcwNjI3L2NyZWF0ZS1kcm9wZG93bi1iYW5uZXItd2hlbi11c2VyLWZpcnN0LXZpc2l0cy13ZWJzaXRlXHJcbiAgLy8gUG96d2FsYWrEhSBvdHdpZXJhxIcgYmFuZXIgdHlsa28gcHJ6eSBwaWVyd3N6ZWogd2l6eWNpZVxyXG4gIFxyXG4gIC8vIGNvb2tpZS1qc1xyXG5cclxuICBcclxuICAgICQoZnVuY3Rpb24oKSB7XHJcbiAgICAgIC8vIFRvdWNoIHJpcHBsZSBlZmZlY3Qgb24gYnV0dG9uc1xyXG4gICAgICAkKCcuYnV0dG9uOm5vdCguYnV0dG9uLmRpc2FibGVkKScpLm9uKCdjbGljaycsXHJcbiAgXHJcbiAgICAgICAgZnVuY3Rpb24oZSkge1xyXG4gIFxyXG4gICAgICAgICAgLyohXHJcbiAgICAgICAgICBTVkcgdmVyc2lvbiBmb3IgcmlwcGxlIGVmZmVjdCB2aWEgSm9uYXRoYW4gQ3V0cmVsbCAoZ2VudGx5IG1vZGlmaWVkKVxyXG4gICAgICAgICAgaHR0cDovL3dlYmRlc2lnbi50dXRzcGx1cy5jb20vdHV0b3JpYWxzL3JlY3JlYXRpbmctdGhlLXRvdWNoLXJpcHBsZS1lZmZlY3QtYXMtc2Vlbi1vbi1nb29nbGUtZGVzaWduLS1jbXMtMjE2NTVcclxuICAgICAgICAgICovXHJcbiAgXHJcbiAgICAgICAgICB2YXIgeCA9IGUucGFnZVg7XHJcbiAgICAgICAgICB2YXIgeSA9IGUucGFnZVk7XHJcbiAgICAgICAgICB2YXIgY2xpY2tZID0geSAtICQodGhpcykub2Zmc2V0KCkudG9wO1xyXG4gICAgICAgICAgdmFyIGNsaWNrWCA9IHggLSAkKHRoaXMpLm9mZnNldCgpLmxlZnQ7XHJcbiAgICAgICAgICB2YXIgYm94ID0gdGhpcztcclxuICBcclxuICAgICAgICAgIHZhciBzZXRYID0gcGFyc2VJbnQoY2xpY2tYKTtcclxuICAgICAgICAgIHZhciBzZXRZID0gcGFyc2VJbnQoY2xpY2tZKTtcclxuICAgICAgICAgIHZhciByaXBwbGUgPSAnPHN2ZyBjbGFzcz1cImlua1wiPjxjaXJjbGUgY3g9XCInICsgc2V0WCArICdcIiBjeT1cIicgKyBzZXRZICsgJ1wiIHI9XCInICsgMCArICdcIj48L2NpcmNsZT48L3N2Zz4nO1xyXG4gIFxyXG4gICAgICAgICAgJCh0aGlzKS5maW5kKCcuaW5rJykucmVtb3ZlKCk7XHJcbiAgICAgICAgICAkKHRoaXMpLmFwcGVuZChyaXBwbGUpO1xyXG4gIFxyXG4gICAgICAgICAgdmFyIGMgPSAkKGJveCkuZmluZCgnY2lyY2xlJyk7XHJcbiAgICAgICAgICBjLmFuaW1hdGUoe1xyXG4gICAgICAgICAgICAncic6ICQoYm94KS5vdXRlcldpZHRoKClcclxuICAgICAgICAgIH0sIHtcclxuICAgICAgICAgICAgZHVyYXRpb246IDMzMyxcclxuICAgICAgICAgICAgc3RlcDogZnVuY3Rpb24odmFsKSB7XHJcbiAgICAgICAgICAgICAgYy5hdHRyKCdyJywgdmFsKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgIGMuZmFkZU91dCgnZmFzdCcpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICBcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gIFxyXG4gICAgICAgIH0pO1xyXG4gIFxyXG4gICAgfSk7XHJcblxyXG4gIC8vIFBvYmllcmFuaWUgbmlja8OzdyB6IHVybCBpIHd5xZt3aWV0bGFuaWUgaWNoIGtvxYJvIGlrb24gc3BvxYJlY3pub8WbY2lvd3ljaFxyXG4gIC8vIG9yYXogd3lrb3J6eXN0YW5pZSB1c2VybmFtZSd1IGdpdGh1YmEgZG8gd3nFm3dpZXRsZW5pYSBvc3RhdG5pZSBha3R5d25vxZtjaVxyXG4gICQoJy51c2VyaW5mbyBhJykuZWFjaChmdW5jdGlvbihpbmRleCkge1xyXG4gICAgdmFyIHByb2ZpbGUgPSAkKHRoaXMpLmF0dHIoJ2hyZWYnKTtcclxuICAgIHZhciBnaXRodWJfcHJvZmlsZSA9IHByb2ZpbGUuc3Vic3RyKDE5KTtcclxuICAgIGlmIChwcm9maWxlLmluZGV4T2YoJ2dpdGh1YicpID4gLTEpIHtcclxuICAgICAgJCgnYVtkYXRhLWdpdGh1Yl0nKS5hcHBlbmQoZ2l0aHViX3Byb2ZpbGUpO1xyXG4gICAgICBHaXRodWIub25seXVzZXJBY3Rpdml0eSh7XHJcbiAgICAgICAgdXNlcm5hbWU6IGdpdGh1Yl9wcm9maWxlLFxyXG4gICAgICAgIHNlbGVjdG9yOiBcIi5naXRodWJcIixcclxuICAgICAgICBsaW1pdDogMTBcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAocHJvZmlsZS5pbmRleE9mKCd0d2l0dGVyJykgPiAtMSkge1xyXG4gICAgICAkKCdhW2RhdGEtdHdpdHRlcl0nKS5hcHBlbmQocHJvZmlsZS5zdWJzdHIoMjApKTtcclxuICAgIH1cclxuICAgIGlmIChwcm9maWxlLmluZGV4T2YoJ2ZhY2Vib29rJykgPiAtMSkge1xyXG4gICAgICAkKCdhW2RhdGEtZmFjZWJvb2tdJykuYXBwZW5kKHByb2ZpbGUuc3Vic3RyKDI1KSk7XHJcbiAgICB9XHJcbiAgfSk7XHJcbiAgXHJcbiAgLy8gR2l0aHViLm9ubHl1c2VyQWN0aXZpdHkoe1xyXG4gIC8vICAgdXNlcm5hbWU6IFwic3luZXJnaWFcIixcclxuICAvLyAgIHNlbGVjdG9yOiBcIi5naXRodWJfc1wiLFxyXG4gIC8vICAgbGltaXQ6IDVcclxuICAvLyB9KTtcclxuXHJcbiAgZnVuY3Rpb24gdGFicyhiTGF6eSkge1xyXG4gICAgLy8gc2V0IGFjdGl2ZSByYWRpbyB0byBhZGRyZXNzIGJhclxyXG4gICAgJChkb2N1bWVudCkub24oJ2NsaWNrJywgJy50YWJzIC50YWJzLW5hdiBsYWJlbCcsIGZ1bmN0aW9uKCkge1xyXG4gICAgICB2YXIgdGFiX25yID0gJCh0aGlzKS5hdHRyKCdmb3InKTtcclxuICAgICAgdmFyIGhhc2ggPSAnIycgKyB0YWJfbnI7XHJcbiAgICAgIHdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSgnJywgJycsIGhhc2gpO1xyXG4gICAgICBpZih0YWJfbnIgPT09ICd0YWItMScpe1xyXG4gICAgICAgIGJMYXp5LmxvYWQoJCgnLnRhYjpudGgtb2YtdHlwZSgxKSAuYmxhenknKSwgdHJ1ZSk7XHJcbiAgICAgIH0gZWxzZSBpZiAodGFiX25yID09PSAndGFiLTInKSB7XHJcbiAgICAgICAgYkxhenkubG9hZCgkKCcudGFiOm50aC1vZi10eXBlKDIpIC5ibGF6eScpLCB0cnVlKTtcclxuICAgICAgfWVsc2UgaWYgKHRhYl9uciA9PT0gJ3RhYi0zJykge1xyXG4gICAgICAgIGJMYXp5LmxvYWQoJCgnLnRhYjpudGgtb2YtdHlwZSgzKSAuYmxhenknKSwgdHJ1ZSk7XHJcbiAgICAgIH1cclxuICBcclxuICAgIH0pO1xyXG4gICAgLy8gc2VsZWN0IGFjdGl2ZSByYWRpbyBiYXNlZCBvbiBoYXNoXHJcbiAgICAkKGRvY3VtZW50LmxvY2F0aW9uLmhhc2gpLnByb3AoJ2NoZWNrZWQnLCB0cnVlKTtcclxuICB9XHJcblxyXG4gIC8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gICAqIEJvb3RzdHJhcDogdHJhbnNpdGlvbi5qcyB2My4zLjZcclxuICAgKiBodHRwOi8vZ2V0Ym9vdHN0cmFwLmNvbS9qYXZhc2NyaXB0LyN0cmFuc2l0aW9uc1xyXG4gICAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gICAqIENvcHlyaWdodCAyMDExLTIwMTUgVHdpdHRlciwgSW5jLlxyXG4gICAqIExpY2Vuc2VkIHVuZGVyIE1JVCAoaHR0cHM6Ly9naXRodWIuY29tL3R3YnMvYm9vdHN0cmFwL2Jsb2IvbWFzdGVyL0xJQ0VOU0UpXHJcbiAgICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovXHJcbiAgXHJcbiAgXHJcbiAgK2Z1bmN0aW9uICgkKSB7XHJcbiAgICAndXNlIHN0cmljdCc7XHJcbiAgXHJcbiAgICAvLyBDU1MgVFJBTlNJVElPTiBTVVBQT1JUIChTaG91dG91dDogaHR0cDovL3d3dy5tb2Rlcm5penIuY29tLylcclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gIFxyXG4gICAgZnVuY3Rpb24gdHJhbnNpdGlvbkVuZCgpIHtcclxuICAgICAgdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYm9vdHN0cmFwJylcclxuICBcclxuICAgICAgdmFyIHRyYW5zRW5kRXZlbnROYW1lcyA9IHtcclxuICAgICAgICBXZWJraXRUcmFuc2l0aW9uIDogJ3dlYmtpdFRyYW5zaXRpb25FbmQnLFxyXG4gICAgICAgIE1velRyYW5zaXRpb24gICAgOiAndHJhbnNpdGlvbmVuZCcsXHJcbiAgICAgICAgT1RyYW5zaXRpb24gICAgICA6ICdvVHJhbnNpdGlvbkVuZCBvdHJhbnNpdGlvbmVuZCcsXHJcbiAgICAgICAgdHJhbnNpdGlvbiAgICAgICA6ICd0cmFuc2l0aW9uZW5kJ1xyXG4gICAgICB9XHJcbiAgXHJcbiAgICAgIGZvciAodmFyIG5hbWUgaW4gdHJhbnNFbmRFdmVudE5hbWVzKSB7XHJcbiAgICAgICAgaWYgKGVsLnN0eWxlW25hbWVdICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgIHJldHVybiB7IGVuZDogdHJhbnNFbmRFdmVudE5hbWVzW25hbWVdIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICBcclxuICAgICAgcmV0dXJuIGZhbHNlIC8vIGV4cGxpY2l0IGZvciBpZTggKCAgLl8uKVxyXG4gICAgfVxyXG4gIFxyXG4gICAgLy8gaHR0cDovL2Jsb2cuYWxleG1hY2Nhdy5jb20vY3NzLXRyYW5zaXRpb25zXHJcbiAgICAkLmZuLmVtdWxhdGVUcmFuc2l0aW9uRW5kID0gZnVuY3Rpb24gKGR1cmF0aW9uKSB7XHJcbiAgICAgIHZhciBjYWxsZWQgPSBmYWxzZVxyXG4gICAgICB2YXIgJGVsID0gdGhpc1xyXG4gICAgICAkKHRoaXMpLm9uZSgnYnNUcmFuc2l0aW9uRW5kJywgZnVuY3Rpb24gKCkgeyBjYWxsZWQgPSB0cnVlIH0pXHJcbiAgICAgIHZhciBjYWxsYmFjayA9IGZ1bmN0aW9uICgpIHsgaWYgKCFjYWxsZWQpICQoJGVsKS50cmlnZ2VyKCQuc3VwcG9ydC50cmFuc2l0aW9uLmVuZCkgfVxyXG4gICAgICBzZXRUaW1lb3V0KGNhbGxiYWNrLCBkdXJhdGlvbilcclxuICAgICAgcmV0dXJuIHRoaXNcclxuICAgIH1cclxuICBcclxuICAgICQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAkLnN1cHBvcnQudHJhbnNpdGlvbiA9IHRyYW5zaXRpb25FbmQoKVxyXG4gIFxyXG4gICAgICBpZiAoISQuc3VwcG9ydC50cmFuc2l0aW9uKSByZXR1cm5cclxuICBcclxuICAgICAgJC5ldmVudC5zcGVjaWFsLmJzVHJhbnNpdGlvbkVuZCA9IHtcclxuICAgICAgICBiaW5kVHlwZTogJC5zdXBwb3J0LnRyYW5zaXRpb24uZW5kLFxyXG4gICAgICAgIGRlbGVnYXRlVHlwZTogJC5zdXBwb3J0LnRyYW5zaXRpb24uZW5kLFxyXG4gICAgICAgIGhhbmRsZTogZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgIGlmICgkKGUudGFyZ2V0KS5pcyh0aGlzKSkgcmV0dXJuIGUuaGFuZGxlT2JqLmhhbmRsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSlcclxuICBcclxuICB9KGpRdWVyeSk7XHJcblxyXG4gICQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCl7XHJcbiAgICAgICQoXCIjbmF2LW1vYmlsZVwiKS5odG1sKCQoXCIjbmF2LW1haW5cIikuaHRtbCgpKTtcclxuICAgICAgJChcIiNuYXYtdHJpZ2dlciAubmF2aWNvbi1idXR0b25cIikuY2xpY2soZnVuY3Rpb24oKXtcclxuICAgICAgICBjb25zb2xlLmluZm8oJ0J1cmdlciBjbGlja2VkJyk7XHJcbiAgICAgICAgICBpZiAoJChcIm5hdiNuYXYtbW9iaWxlIHVsXCIpLmhhc0NsYXNzKFwiZXhwYW5kZWRcIikpIHtcclxuICAgICAgICAgICAgICAkKFwibmF2I25hdi1tb2JpbGUgdWwuZXhwYW5kZWRcIikucmVtb3ZlQ2xhc3MoXCJleHBhbmRlZFwiKS5zbGlkZVVwKDI1MCk7XHJcbiAgICAgICAgICAgICAgJCh0aGlzKS5yZW1vdmVDbGFzcyhcIm9wZW5cIik7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICQoXCJuYXYjbmF2LW1vYmlsZSB1bFwiKS5hZGRDbGFzcyhcImV4cGFuZGVkXCIpLnNsaWRlRG93bigyNTApO1xyXG4gICAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoXCJvcGVuXCIpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7XHJcbiAgICBTbGlkZXIgPSAkKCcjc2xpZGVyJykuU3dpcGUoe1xyXG4gICAgICBhdXRvOiAwLFxyXG4gICAgICBjb250aW51b3VzOiB0cnVlLFxyXG4gICAgfSkuZGF0YSgnU3dpcGUnKTtcclxuICAgIGlmIChTbGlkZXIpIHtcclxuICAgICAgJCgnLm5leHQnKS5vbignY2xpY2snLCBTbGlkZXIubmV4dCk7XHJcbiAgICAgICQoJy5wcmV2Jykub24oJ2NsaWNrJywgU2xpZGVyLnByZXYpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICAvLyBQxYJ5bm5lIHNrcm9sb3dhbmllIC8vXHJcbiAgLy8gaHR0cHM6Ly9jc3MtdHJpY2tzLmNvbS9zbmlwcGV0cy9qcXVlcnkvc21vb3RoLXNjcm9sbGluZy8jY29tbWVudC0xOTcxODFcclxuICBcclxuICBqUXVlcnkoZnVuY3Rpb24oJCkge1xyXG4gICAgJCgnYVtocmVmKj0jXTpub3QoW2hyZWY9I10pJykuY2xpY2soZnVuY3Rpb24oKSB7XHJcbiAgICAgIGlmIChsb2NhdGlvbi5wYXRobmFtZS5yZXBsYWNlKC9eXFwvLywgJycpID09IHRoaXMucGF0aG5hbWUucmVwbGFjZSgvXlxcLy8sICcnKSB8fCBsb2NhdGlvbi5ob3N0bmFtZSA9PSB0aGlzLmhvc3RuYW1lKSB7XHJcbiAgXHJcbiAgICAgICAgdmFyIHRhcmdldCA9ICQodGhpcy5oYXNoKTtcclxuICAgICAgICB0YXJnZXQgPSB0YXJnZXQubGVuZ3RoID8gdGFyZ2V0IDogJCgnW25hbWU9JyArIHRoaXMuaGFzaC5zbGljZSgxKSArICddJyk7XHJcbiAgICAgICAgaWYgKHRhcmdldC5sZW5ndGgpIHtcclxuICAgICAgICAgICQoJ2h0bWwsYm9keScpLmFuaW1hdGUoe1xyXG4gICAgICAgICAgICBzY3JvbGxUb3A6IHRhcmdldC5vZmZzZXQoKS50b3BcclxuICAgICAgICAgIH0sIDEwMDApO1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIC8qKlxyXG4gICAqIENyZWF0ZWQgYnkgcGxrcyBvbiAyMDE2LTAzLTA5LlxyXG4gICAqL1xyXG4gIFxyXG4gICQoJ2RvY3VtZW50JykucmVhZHkoZnVuY3Rpb24gKCkge1xyXG4gICAgICB2YXIgdGFncyA9IEFycmF5KCdyb2JvdHMnLCAnc2NpZmknLCAnc2NpX2ZpJywgJ3JvYm90JywgJ2VsZWN0cm9uaWNzJywgJ2NvZGUnKTtcclxuICAgICAgJC5nZXQoJ2h0dHA6Ly9hcGkuZ2lwaHkuY29tL3YxL2dpZnMvcmFuZG9tJywge1xyXG4gICAgICAgICAgJ2FwaV9rZXknOiAnZGM2emFUT3hGSm16QycsXHJcbiAgICAgICAgICAndGFnJzogdGFnc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB0YWdzLmxlbmd0aCldXHJcbiAgICAgIH0sIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAvL2NvbnNvbGUubG9nKCdkYXRhICcgKyBkYXRhLnVybCk7XHJcbiAgICAgICAgICAkKCcuZ2lmJykuaHRtbCgnPGltZyBzcmM9XCInICsgZGF0YS5kYXRhLmltYWdlX29yaWdpbmFsX3VybCArICdcIiBoZWlnaHQ9XCIxMDAlXCIgd2lkdGg9XCIxMDAlXCI+PC9pbWc+Jyk7XHJcbiAgICAgIH0pO1xyXG4gIFxyXG4gIH0pO1xyXG5cclxuICAkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHtcclxuXHJcbiAgICAgIHZhciBiTGF6eSA9IG5ldyBCbGF6eSh7XHJcbiAgICAgICAgb2Zmc2V0OiAyMCxcclxuICAgICAgICBzZWxlY3RvcjogJy5ibGF6eScsXHJcbiAgICAgICAgbG9hZEludmlzaWJsZTogZmFsc2UsXHJcbiAgICAgICAgYnJlYWtwb2ludHM6IFt7XHJcbiAgICAgICAgICB3aWR0aDogMzYwLCAvLyBNYXgtd2lkdGhcclxuICAgICAgICAgIHNyYzogJ2RhdGEtc3JjLXNtYWxsJ1xyXG4gICAgICAgIH1dLFxyXG4gICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGVsZW1lbnQpIHtcclxuICAgICAgICAgICQoZWxlbWVudCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnLCA1MDApO1xyXG4gICAgICAgICAgdXBkYXRlQ291bnRlcigpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKGVsZW1lbnQsIG1zZykge1xyXG4gICAgICAgICAgaWYgKG1zZyA9PT0gJ21pc3NpbmcnKSB7XHJcbiAgICAgICAgICAgICQoZWxlbWVudCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnLCA1MDApOyAvLyBEYXRhLXNyYyBpcyBtaXNzaW5nXHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJiTGF6eTogZGF0YS1zcmMgaXMgbWlzc2luZ1wiKTtcclxuICAgICAgICAgIH0gZWxzZSBpZiAobXNnID09PSAnaW52YWxpZCcpIHtcclxuICAgICAgICAgICAgJChlbGVtZW50KS5wYXJlbnQoKS5yZW1vdmVDbGFzcygnbG9hZGluZycsIDUwMCk7XHJcbiAgICAgICAgICAgIC8vIERhdGEtc3JjIGlzIGludmFsaWRcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcImJMYXp5OiBkYXRhLXNyYyBpcyBpbnZhbGlkXCIpO1xyXG4gICAgXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgLy8gbm90IG5lZWRlZCwgb25seSBoZXJlIHRvIGlsbHVzdHJhdGUgYW1vdW50IG9mIGxvYWRlZCBpbWFnZXNcclxuICAgICAgdmFyIGltYWdlTG9hZGVkID0gMDtcclxuICAgIFxyXG4gICAgICBmdW5jdGlvbiB1cGRhdGVDb3VudGVyKCkge1xyXG4gICAgICAgIGltYWdlTG9hZGVkKys7XHJcbiAgICAgICAgY29uc29sZS5pbmZvKFwiYkxhenk6IEltYWdlcyBsb2FkZWQ6ICVkXCIsIGltYWdlTG9hZGVkKTtcclxuICAgICAgfVxyXG4gICAgXHJcbiAgICAgIHRhYnMoYkxhenkpO1xyXG5cclxuICAgIC8vIGh0dHA6Ly9hcnJlc3RlZGRldmVsb3Blci5uZXQvd29yZHByZXNzLWluZmluaXRlLXNjcm9sbC13aXRoLXdvcmRwcmVzcy1wb3N0cy1hbmQtd2F5cG9pbnRzLWpzL1xyXG4gICAgXHJcbiAgICAvLyBDaHliYSB6IHRlZ28genJvYmnEhyBuYWxlxbx5IG9iamVrdFxyXG4gICAgXHJcbiAgICB2YXIgcHJvamVjdF9zdGF0dXMgPSBqUXVlcnkoJyNmaW5pc2hlZF9wcm9qZWN0cycpLmF0dHIoJ2RhdGEtcHJvamVjdHMtc3RhdHVzJyk7XHJcbiAgICB2YXIgYWpheF91cmwgPSBqUXVlcnkoJyNwcm9qZWN0cycpLmF0dHIoJ2RhdGEtYWpheC11cmwnKTtcclxuICAgIHZhciB0b3RhbF9maW5pc2hlZF9wcm9qZWN0cyA9IGpRdWVyeSgnI2ZpbmlzaGVkX3Byb2plY3RzJykuYXR0cignZGF0YS10b3RhbC1maW5pc2hlZC1wcm9qZWN0cycpO1xyXG4gICAgdmFyIHRvdGFsX2luX3Byb2dyZXNzX3Byb2plY3RzID0galF1ZXJ5KCcjaW5fcHJvZ3Jlc3NfcHJvamVjdHMnKS5hdHRyKCdkYXRhLXRvdGFsLWluLXByb2dyZXNzLXByb2plY3RzJyk7XHJcbiAgICB2YXIgdG90YWxfaWRlYXNfcHJvamVjdHMgPSBqUXVlcnkoJyNpZGVhc19wcm9qZWN0cycpLmF0dHIoJ2RhdGEtdG90YWwtaWRlYXMtcHJvamVjdHMnKTtcclxuICAgIHZhciBwb3N0X29mZnNldCA9IDA7XHJcbiAgICB2YXIgbG9hZGVkX2ZpbmlzaGVkX3Byb2plY3RzID0gMDtcclxuICAgIFxyXG4gICAgLy8gU2tyb2x1amVteSBkbyBzdG9wa2ksIHd0ZWR5IHVydWNoYW1pYSBzacSZIGZ1bmtjamEgbG9hZFByb2plY3RzKClcclxuICAgIGlmIChhamF4X3VybCkge1xyXG4gICAgICAkKHdpbmRvdykuc2Nyb2xsKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIGlmICgkKHdpbmRvdykuc2Nyb2xsVG9wKCkgPj0gJChkb2N1bWVudCkuaGVpZ2h0KCkgLSAkKHdpbmRvdykuaGVpZ2h0KCkgLSAxMDApIHtcclxuICAgICAgICAgIGlmICgkKCcjaWRlYXNfcHJvamVjdHMnKS5pcygnOnZpc2libGUnKSkge1xyXG4gICAgICAgICAgICBsb2FkZWRfaWRlYXNfcHJvamVjdHMgPSAkKCcjaWRlYXNfcHJvamVjdHMnKS5jaGlsZHJlbigpLmxlbmd0aDtcclxuICAgICAgICAgICAgbG9hZFByb2plY3RzKCdpZGVhcycsIHRvdGFsX2lkZWFzX3Byb2plY3RzLCBsb2FkZWRfaWRlYXNfcHJvamVjdHMpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZWxzZSBpZiAoJCgnI2luX3Byb2dyZXNzX3Byb2plY3RzJykuaXMoJzp2aXNpYmxlJykpIHtcclxuICAgICAgICAgICAgbG9hZGVkX2luX3Byb2dyZXNzX3Byb2plY3RzID0gJCgnI2luX3Byb2dyZXNzX3Byb2plY3RzJykuY2hpbGRyZW4oKS5sZW5ndGg7XHJcbiAgICAgICAgICAgIGxvYWRQcm9qZWN0cygnaW5fcHJvZ3Jlc3MnLCB0b3RhbF9pbl9wcm9ncmVzc19wcm9qZWN0cywgbG9hZGVkX2luX3Byb2dyZXNzX3Byb2plY3RzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGVsc2UgaWYgKCQoJyNmaW5pc2hlZF9wcm9qZWN0cycpLmlzKCc6dmlzaWJsZScpKSB7XHJcbiAgICAgICAgICAgIGxvYWRlZF9maW5pc2hlZF9wcm9qZWN0cyA9ICQoJyNmaW5pc2hlZF9wcm9qZWN0cycpLmNoaWxkcmVuKCkubGVuZ3RoO1xyXG4gICAgICAgICAgICBsb2FkUHJvamVjdHMoJ2ZpbmlzaGVkJywgdG90YWxfZmluaXNoZWRfcHJvamVjdHMsIGxvYWRlZF9maW5pc2hlZF9wcm9qZWN0cyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBsb2FkUHJvamVjdHMocHJvamVjdHNfc3RhdHVzLCB0b3RhbF9wcm9qZWN0cywgbG9hZGVkX3Byb2plY3RzKSB7XHJcbiAgICAgIHBvc3Rfb2Zmc2V0ID0gcGFyc2VJbnQocG9zdF9vZmZzZXQpICsgNjtcclxuICAgICAgY29uc29sZS5pbmZvKFwiTG9hZGVkICVzIHByb2plY3RzOiAlZC8lZFwiLHByb2plY3RzX3N0YXR1cywgbG9hZGVkX3Byb2plY3RzLCB0b3RhbF9wcm9qZWN0cyk7XHJcbiAgICBcclxuICAgICAgaWYgKHRvdGFsX3Byb2plY3RzID4gbG9hZGVkX3Byb2plY3RzKSB7XHJcbiAgICAgICAgJCgnLmxvYWRlcicpLnNob3coKTtcclxuICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgdXJsOiBhamF4X3VybCxcclxuICAgICAgICAgIHR5cGU6ICdQT1NUJyxcclxuICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgYWN0aW9uOiAnbG9hZF9wcm9qZWN0cycsXHJcbiAgICAgICAgICAgIHBvc3Rfb2Zmc2V0OiBwb3N0X29mZnNldCxcclxuICAgICAgICAgICAgcHJvamVjdHNfc3RhdHVzOiBwcm9qZWN0c19zdGF0dXMsXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oZGF0YSkge1xyXG4gICAgICAgICAgICAkKCcjJyArIHByb2plY3RzX3N0YXR1cyArICdfcHJvamVjdHMnKS5hcHBlbmQoZGF0YSk7XHJcbiAgICAgICAgICAgIC8vICQoZGF0YSkuaGlkZSgpLmFwcGVuZFRvKCcjJyArIHByb2plY3RzX3N0YXR1cyArICdfcHJvamVjdHMnKS5zaG93KDIwMCk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuaW5mbygnQWpheDogTG9hZGVkIG1vcmUgJXMgcHJvamVjdHMnLCBwcm9qZWN0c19zdGF0dXMpO1xyXG4gICAgICAgICAgICBiTGF6eS5yZXZhbGlkYXRlKCk7XHJcbiAgICAgICAgICAgIGNhcmRFeGNlcnB0KCk7XHJcbiAgICAgICAgICAgICQoJy5sb2FkZXInKS5oaWRlKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gIH0pO1xyXG4gIC8vIFByZXplcyB6YXdzemUgbmEgcGllcndzenltIG1pZWpzY3UgLy9cclxuICAkKCcjbWFuYWdlbWVudF9ib2FyZCBsaSNhZG1pbicpLmluc2VydEJlZm9yZSgnI21hbmFnZW1lbnRfYm9hcmQgbGk6ZXEoMCknKTtcclxufSk7Il0sImZpbGUiOiJtYWluLm1pbi5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
